# 让 dev.to 快得不可思议

> 原文:[https://dev.to/ben/making-devto-insanely-fast](https://dev.to/ben/making-devto-insanely-fast)

当有人称赞这个网站的加载速度时，我会笑，因为这不是偶然的。我们为此付出了很多努力。这种事情*通常*不会被注意到，但是当你的读者是开发者时，他们更有可能注意到并欣赏它。我以前写过关于这个[的文章](https://dev.to/t/web-performance)，但是值得重新审视，因为这些想法总是在发展。

从一开始，我们的想法就是，如果我们能让一切都快得令人疯狂，那么 UX 的其他考虑都会变得容易得多。对我来说，网页的性能是 UX 最重要的考虑因素。没有人愿意花时间盯着一个空白的屏幕。不管那些小的接触，人们会想要回到一个不会在白屏上浪费时间的网站。

但是速度不是免费的。为了确保性能，项目必须有一组合理的约束。早期对性能的关注有助于规划站点的架构，以适应确保高渲染速度的限制。未来的决策不太可能必须权衡性能，因为性能考虑是整个网站结构的中心。

web 上的大多数性能问题都归结于理解瓶颈在哪里。在此基础上，我们需要确定我们可以做出什么样的权衡来消除它们。具有不同关注点的人之间很难进行权衡。我相信这个项目的成功很大一部分是因为我很好地掌握了自顶向下的问题以及如何实现它。很难立刻向设计师解释为什么我们不能总是在页面上有自定义内容，或者让设计师向我解释他们为什么需要它。

## 设计约束

我们可以了解应用程序的哪些方面来决定我们可以对架构做出什么样的决定？对于 [dev.to](https://dev.to) ，我认为这是一个非常重读取的应用程序，并且有一个很好的机会来执行大量缓存。这是一个在功能上做到极简主义的机会，也是一个把重要的东西——内容消费——最小化、最大化的机会。了解可用的基础设施工具也很重要。不要围绕没有人提供合理服务的基础设施来构建项目。

从根本上说，最大限度地提高 web 性能与缓存和延迟缓解有关。这个应用程序是一系列博客文章。每当一篇文章被更新或被评论时，都会有很多动态的读写动作。但大多数行为是用户来到网站，阅读或浏览内容，然后离开。为了更好地服务于这种行为，我们充分利用了边缘缓存。这意味着，如果你从纽约访问这个网站，你将得到一个静态的、压缩的 HTML 页面。如果您从伦敦访问，您将获得缓存页面的伦敦版本。如果你从尼日利亚访问，你会得到西班牙的版本，因为那是最接近的节点。这比一个网站从犹他州或其他地方提供所有内容要好得多。

如果不能提供完全静态的内容，同样的原则也适用于基于区域的数据复制。随着我们网站功能集的增长，我很高兴能在这个意义上扩展我们的能力，但以简单的方式从最佳性能开始是单人操作的关键。我们使用 Fastly 来满足我们的 CDN 边缘缓存需求。我们非常喜欢他们的服务。完全披露，Fastly 现在是我们的赞助商，但我们这样做是因为我们爱他们，而不是相反。

## 初始页面请求

典型的请求首先返回一个完全缓存的、预压缩的 HTML 页面，该页面从最近的 Fastly 节点提供(如果有的话)。额外的“动态”信息，如你喜欢的评论等。经历第二个轻量级的请求，该请求命中应用程序数据库并返回相关信息。这些数据中有很多是被缓存的，但是它的缓存键是基于特定的用户会话的，所以我们现在还不能从边缘返回这些数据。我们计划在客户机上存储更多的数据，这样我们就不需要经常从数据源获取数据，但是目前还没有实现。

## 消除渲染阻塞样式和脚本

一旦一个页面被提交，下一个重要的细节是尽可能快地渲染它。在我看来，这是很多网站，甚至是那些通过 CDN 从边缘提供完全静态内容的网站经常做不到的。缩短渲染时间的关键是消除所有渲染阻塞延迟。这意味着没有外部 CSS 请求，没有自定义字体，也没有同步 JavaScript。

是的，所有与初始渲染相关的 CSS 都是通过一个`<style>`标签来的，页面结构的任何部分都不依赖于任何 JavaScript 执行。这确保了即使当用户带着完全清空的缓存访问站点时，他们仍然可以几乎即时地看到站点的所有内容。按照惯例，所有站点的样式逻辑都被组织到样式表中，并且为了方便和整洁，使用了 SCSS，但是相关的 CSS 在运行时被打印到页面上，当然，所有内容都在后续请求中被缓存。

图像会自动优化压缩，并根据浏览器(webp for Chrome，jpeg for Safari 等)以最有效的格式提供。).这是 Cloudinary 提供的服务。Cloudinary 还尽可能充分利用 HTTP2，因此我们不必考虑它。

大的封面图像的背景颜色被设置为图像的近似颜色，所以当图像加载时，这是一个更好的过渡。我在页面内联了一个非常低分辨率的模糊图像，但这本身增加了额外的页面重量，并增加了渲染引擎完成工作的时间。将来可能会有其他解决方案。

我很高兴能够尝试新的本地元素，这将有助于我们提供更小的图像。然而，我们还没有利用这一点。

## 底线

网络性能是最重要的用户体验考虑因素。当人们点击这个网站的链接时，我不希望他们在页面加载时习惯性地转到另一个标签。我希望他们有信心在手机上点击，并期待获得非常快的页面加载时间，即使网络条件参差不齐。尝试点击网络上有大量外部 CSS 和自定义字体的页面。你会过得很糟糕。我希望世界各地的读者，不管他们的设备、网络和与我们主要地区的距离如何，都有相同的闪电般的页面请求时间。我希望那些在我们网站上发布博客的开发者相信，我们正在不断地改进用户体验的重要部分。

我希望这有所帮助。请随时提问或在下面留下评论。