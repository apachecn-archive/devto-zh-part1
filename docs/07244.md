# 在自动气象站网络上运行域名系统:挑战与教训

> 原文:[https://dev . to/sparkpost/operating-DNS-on-the-AWS-network-challenge-and-lessons](https://dev.to/sparkpost/operating-dns-on-the-aws-network-challenges-and-lessons)

## [](#a-dns-performance-incident)一次 DNS 性能事件

在 SparkPost，我们正在建立一个具有高性能、可扩展性和可靠性的电子邮件传递服务。我们将这些品质作为关键设计目标，它们是我们设计和运营服务的核心。事实上，我们确实为我们的[企业服务级别客户](https://www.sparkpost.com/enterprise-email/)保证了我们的服务级别和突发率。

然而，我们有时会遇到对我们的性能有负面影响的技术限制或操作条件。我们最近经历了这样一个具有挑战性的情况。[5 月 24 日](https://status.sparkpost.com/incidents/v53x9z1rb7jh?_ga=2.121762895.595315268.1496870660-424867781.1485888065)，我们的 DNS 基础设施与 AWS 网络堆栈的交互出现问题，导致我们的一些客户出现错误、延迟和系统性能下降。

当这样的事情发生时，我们会尽一切努力去弥补。我们还向我们的客户承诺，对发生的事情和我们学到的东西保持公开透明。

在这篇文章中，我将讨论发生了什么，以及我们从那次事件中学到了什么。但首先我想说，我们对这个问题及其对客户的影响承担责任。

我们知道我们的客户依赖可靠的电子邮件服务来支持他们的业务、安全和运营需求。当我们不能提供客户期望的服务水平时，我们会严肃对待。对此我很抱歉，我们整个团队也是。

## AWS 网络上的极端 DNS 使用率达到极限

为什么会出现这种放缓？我们的团队很快意识到，来自我们服务的常规 DNS 查询没有得到合理的答复。我们将问题追溯到我们在[亚马逊网络服务(AWS)](https://aws.amazon.com/) 平台上运行的 DNS 基础设施。最初，我们试图通过将 DNS 服务器容量增加 500%来解决查询性能问题，但这并没有解决问题，我们继续遇到无法解释的严重节流。然后，我们在每个 AWS 网段的本地域名服务器上为绝大多数客户重新打印了 DNS 服务，没有遇到性能问题。这不是 AWS 为我们的 DNS 卷推荐的长期方法，但我们与 AWS 协调了这一方法，作为一项临时措施，允许我们在事件开始后大约五个小时内完全恢复所有客户的服务。

我以前写过关于[DNS 基础设施对电子邮件传递有多重要](https://www.sparkpost.com/blog/undocumented-limit-dns-aws/)，以及 DNS 问题可能暴露云网络和托管中的漏洞或意外限制的方式。简而言之，电子邮件大量使用 DNS，而 SparkPost 使用 DNS 的次数几乎比任何其他 AWS 客户都多。因此，DNS 对我们服务的整体性能有着巨大的影响。

在这种情况下，DNS 性能下降的根本原因是 AWS 网络堆栈中另一个未记录的实际限制。该限制是在一组特定的情况下触发的，其中实际流量负载只是一个组成部分。

像这样的限制在任何网络基础设施中都是意料之中的。但是，云带来独特挑战的一个领域是，当网络堆栈本身是一个抽象概念，流量交互比在传统环境中更多地是一种共同责任时，解决这些问题。

在事故期间诊断这个问题对我们和 AWS 支持团队来说都很困难。事后，最终需要 AWS 工程团队几天的努力和帮助，在测试环境中重现问题，然后确定根本原因。

## [](#working-with-the-aws-team)与 AWS 团队合作

抛开技术不谈，我们知道我们的客户从我们的技术和服务团队的专业知识中受益匪浅，他们从里到外都了解电子邮件。当我们说“我们的技术让这一切成为可能，我们的员工让这一切变得不同”时，我们是认真的

与亚马逊的合作也是如此。AWS 团队在识别和解决上周影响我们服务的 DNS 性能问题的整个过程中发挥了重要作用。SparkPost 的站点可靠性工程团队与我们的 AWS 同行密切合作，直到我们清楚地了解了根本原因。

以下是我们在一起解决这类问题时学到的一些东西:

*   您的 AWS 技术客户经理是您的盟友。利用您的客户团队。他们是 AWS 内部资源和服务的倡导者和引导者。他们可以联系产品经理和 AWS 内部的工程资源。他们可以搜寻在线文档中不容易找到的内部信息。他们真的了解像我们遇到的这种问题对业务运营有多紧迫。如果支持票或其他问题没有得到应有的关注，请不要犹豫，继续努力。

*   向 AWS 介绍您独特的使用案例。确保 AWS 客户团队——尤其是您的 TAM 团队和解决方案架构师——尽可能多地参与您的日常工作流程。这样，他们可以直接了解您的需求，并在 AWS 中表示出来。这是保持意外惊喜数量最小化的一个非常重要的部分。

*   运行系统测试并生成数据，以帮助 AWS 排除故障。亚马逊团队将调查他们那边的情况，当然他们在平台层有很好的工具和可见性来完成这项工作。但是它们不能复制您的设置，尤其是当您已经构建了像我们这样高度专业化和复杂的服务时。运行系统测试并将数据提供给 AWS 团队将为他们提供非常宝贵的信息，有助于将未知问题隔离到平台基础设施的特定元素。在这些测试中，他们可以监控他们那边的情况，以获得对问题的更多了解。

*   让两个团队的工程师能够轻松地直接协作。虽然您的客户团队至关重要，但他们也知道何时让 AWS 的工程师和您的工程师直接合作将节省时间并改善沟通。尽可能简单地做到这一点对你有利。例如，邀请 AWS 团队进入一个共享的 Slack 频道是一种很好的实时合作方式——并记录交互以帮助进一步排除故障并在未来重现上下文。利用 Google docs 等其他协作工具来分享发现和计划。在事故期间将 AWS 团队带到您的运营桥梁线上，并在事故发生后使用电话会议进行定期检查。

*   明白你们是同舟共济的。 AWS 是用于构建云原生服务的[伟大技术栈](https://www.sparkpost.com/blog/aws-instead-data-center/)。但我们开始欣赏亚马逊的一点是，当 SparkPost 这样的专业服务将 AWS 基础设施推向一些边缘情况时，他们如何公开解决困难问题。他们的团队帮助我们了解根本原因，开发解决方案，并最终将他们的经验用于帮助 AWS 自身继续发展。

AWS 网络和平台是 SparkPost 云架构的关键部分。我们已经从技术角度积累了一些关于利用 AWS 的丰富知识。我们也逐渐意识到，当基础设施中出现问题时，来自 AWS 团队的支持在解决这些问题时是多么重要。

## [](#looking-ahead)展望未来

在接下来的几周，我们将会写更多关于 DNS 架构变化的细节。它们是提高基础设施弹性的重要一步。

无论您是自己在构建 AWS 网络，还是依赖我们云基础设施的 SparkPost 客户，我希望对我们所学内容的解释有所帮助。当然，如果你想讨论上周的事件，请联系我或任何 SparkPost 团队。

*这篇文章最初发表在 [SparkPost 的博客](https://www.sparkpost.com/blog/dns-aws-network-lessons/)上。*