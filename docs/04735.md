# RESTful API 版本控制最佳实践:为什么 v1 是第一名

> 原文:[https://dev . to/sparkpost/restful-API-versioning-best-practices-why-v1-is-1](https://dev.to/sparkpost/restful-api-versioning-best-practices-why-v1-is-1)

## [](#breaking-changes-bad-api-versioning-good)破变坏！API 版本控制很好！

正如任何已经构建或经常使用 API 的人迟早会意识到的那样，突破性的改变是非常糟糕的，并且会给原本有用的 API 带来非常严重的缺陷。突破性改变是对 API 行为的改变，这种改变会破坏用户的集成，并导致 API 提供者和用户之间的许多挫折和信任的丧失。突破性的改变需要提前通知用户(伴随着道歉),而不是一个刚刚出现的改变，比如一个令人愉快的新特性。避免这种挫败感的方法是，在 API 所有者保证不会在任何单一版本中引入令人惊讶的变化的情况下，对 API 进行版本化。

那么给一个 API 版本化有多难呢？事实并非如此，但困难的是保持一定的理智，不要不必要地陷入令人眼花缭乱的版本和颠覆，这些版本和颠覆应用于几十个兼容性不明确的 API 端点。

我们在三年前引入了 API 的 v1，并没有意识到它会发展到今天。那么，我们是如何在两年多的时间里继续提供最好的电子邮件交付 API，同时仍然保持相同的 API 版本的呢？虽然关于如何对 REST APIs 进行版本控制有许多不同的观点，但我希望我们谦逊而强大的 v1 的故事可以引导你走向 API 版本控制的启蒙之路。

## [](#rest-is-best)休息最好

SparkPost API 起源于[,那时我们还是消息系统](https://www.sparkpost.com/blog/devops-journey-continuous-deployment/),在我们的云冒险之前。当时我们正忙着为 Momentum 4 的测试版做最后的准备。这是对我们市场领先的本地 MTA 版本 3.x 的重大升级。Momentum 4 包括一个全新的 UI、实时分析，最重要的是一个新的 web API，用于消息注入和生成、管理模板和获取电子邮件指标。我们的愿景是一个 API 优先的架构——甚至 UI 也可以与 API 端点进行交互。

我们做出的最早也是最好的决定之一是采用 RESTful 风格。自 21 世纪后期以来，基于表述性状态转移( [REST](https://en.wikipedia.org/wiki/Representational_state_transfer) )的 web APIs 是云 API 的事实上的标准。使用 HTTP 和 JSON 可以让开发人员轻松地集成我们的 API，而无需了解或关心我们的底层技术，无论他们使用哪种编程语言——PHP、Ruby 和 Java。

选择使用 RESTful 架构很容易。选择版本约定并不容易。最初，我们对版本化的问题避而不谈，根本不对测试版进行版本化。然而，几个月后，测试版就在少数客户手中，我们开始构建我们的云服务。版本时间到了。我们评估了两个版本约定。第一种是将版本控制直接放在 URI 中，第二种是使用 Accept 头。第一个选项更显式，不太复杂，对开发人员来说更容易。因为我们热爱开发人员，所以这是合乎逻辑的选择。

## [](#api-governance)API 治理

随着版本约定的选择，我们有了更多的问题。我们什么时候修改版本？什么是突破性的改变？我们是逆转整个 API 还是仅仅逆转某些端点？在 SparkPost，我们有多个团队在我们 API 的不同部分工作。在这些团队中，人们在不同的时间在不同的端点上工作。因此，我们的 API 在约定的使用上保持一致是非常重要的。这比版本控制更重要。

我们建立了一个治理小组，包括代表每个团队的工程师、产品管理团队的成员和我们的 CTO。这个小组负责在所有团队中建立、记录和执行我们的 API 约定。API 治理松弛通道对于关于该主题的热烈讨论也很有用。

治理小组确定了许多可以将变更引入 API 的方法，这些方法对用户是有益的，并且不会构成重大变更。其中包括:

*   新的资源或 API 端点
*   一个新的可选参数
*   对非公共 API 端点的更改
*   JSON POST 主体中一个新的可选键
*   JSON 响应体中返回的新键

相反，重大变更包括任何可能破坏用户集成的内容，例如:

*   一个新的必需参数
*   邮件正文中一个新的必需键
*   删除现有端点
*   删除现有的端点请求方法
*   API 调用本质上不同的内部行为——例如对默认行为的更改。

## [](#the-big-10)大 1.0

当我们记录和讨论这些约定时，我们也得出结论，这是每个人的(包括我们的！)最感兴趣的是避免对 API 进行破坏性的更改，因为管理多个版本会增加相当多的开销。我们决定，在提交“v1”之前，我们应该用我们的 API 解决一些问题。

发送一封简单的电子邮件需要太多的努力。为了“保持简单的事情简单”,我们更新了文章主体，以确保简单和复杂的用例都被容纳。新的格式也更加经得起未来的考验。其次，我们解决了指标端点的问题。此端点使用了“group_by”参数，该参数将更改 GET 响应正文的格式，以便第一个键是 group by 参数的值。这看起来不太 RESTful，所以我们将每个组分成一个单独的端点。最后，我们审计了每个端点，并做了一些小的改动，以确保它们符合标准。

## [](#accurate-documentation)准确的文档记录

拥有准确和可用的 API 文档以避免有意或无意的破坏性更改是很重要的。我们决定使用一种简单的 API 文档方法，利用名为 [API Blueprint](https://apiblueprint.org/) 的 Markdown 语言和[在 Github](https://github.com/SparkPost/sparkpost-api-documentation) 中管理我们的文档。我们的社区贡献并改进了这些开源文档。我们还在 Github 中为内部 API 和端点维护了一组非公开的文档。

最初，我们将我们的文档发布到 [Apiary](https://apiary.io/) ，这是一个用于原型化和发布 API 文档的伟大工具。然而，将 Apiary 嵌入到我们的网站并不能在移动设备上运行，所以我们现在使用 [Jekyll](https://jekyllrb.com/) 来生成静态文档。我们最新的 [SparkPost API 文档](https://developers.sparkpost.com/api/?_ga=2.83083859.498376997.1496197593-424867781.1485888065)现在可以在移动设备上快速加载并运行良好，这对那些不经常坐在电脑前的开发者来说非常重要。

## [](#separating-deployment-from-release)部署与发布分离

我们很早就学习了将部署从发布中分离出来的有价值的技巧。这样，当变更通过[连续交付和部署](https://www.sparkpost.com/blog/continuous-integration-deployment/)准备就绪时，可以频繁地部署变更，但我们并不总是同时公开宣布或记录它们。对于我们来说，在公开记录和支持它之前，部署一个新的 API 端点或现有 API 端点的增强，并在 UI 内或通过内部工具使用它并不罕见。这样，我们可以对它进行一些调整，以提高可用性或符合标准，而不必担心做出令人恐惧的重大更改。一旦我们对变更感到满意，我们就将它添加到我们的公共文档中。

## [](#doh)Doh！

公平地说，我们有时没有实现“不要突破性变革”的理想，这是值得学习的。有一次，我们认为如果某个属性默认为 true 而不是 false，对用户来说会更好。在我们部署了这个改变之后，我们收到了一些用户的抱怨，因为行为发生了意想不到的变化。我们恢复了更改并添加了帐户级别设置——这无疑是一种更加用户友好的方法。

偶尔，我们会因为错误修复而引入突破性的变化。然而，为了一致性，我们决定不管这些特性，而不是冒险破坏客户的集成。

在极少数情况下，我们会为了更大的用户群体的利益，在确认对用户影响很小甚至没有影响的情况下，做出重大的决策，做出突破性的改变——比如放弃一个 API 资源或方法。例如，我们特意选择[改变抑制 API](https://www.sparkpost.com/blog/suppression-list-api-updates/) 的响应行为，但只是在仔细权衡了对社区的好处和影响，并与我们的用户仔细沟通了这一变化之后。但是，我们绝不会引入任何可能直接影响用户生产电子邮件发送的变更。

## [](#introducing-v2-not-yet)引入 v2–还没有！

谁知道 SparkPost API 的 v1 会继续统治多久。这肯定超出了我的预期。发布 API v2 的驱动因素是什么？我很想听听你对这个话题的看法。如果您对我们的 API 版本有任何疑问，或者希望获得如何最好地解决您自己的 API 版本挑战的建议，请不要犹豫，联系 [Twitter](https://twitter.com/SparkPost) 。如果你喜欢构建令人敬畏的 API，你很幸运，因为我们[总是在雇佣](https://www.sparkpost.com/careers/open-positions/)。要了解更多关于我们如何构建 API 的信息，请查看【SparkPost 如何为开发者构建最好的电子邮件 API。

这篇文章最初发表在 [SparkPost 博客](https://www.sparkpost.com/blog/api-versioning-best-practices/)上。