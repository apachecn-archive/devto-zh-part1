# Ansible 第 1 部分:Linux 主机更新

> 原文：<https://dev.to/just_insane/ansible-part-1-linux-host-updates-2b73>

这篇文章将作为 Ansible 的一个介绍，让你体验一下它的功能。

Ansible 是一个配置管理、应用程序部署、任务自动化和 IT 编排工具。简而言之，它允许您获得系统配置的真实来源，部署系统级和 web 级应用程序(从 nginx 到您公司的分布式高可用性 web 应用程序)，自动化常见的重复任务，并按顺序完成所有这些，以创建一个事件链，从而完全重建您的基础架构。

作为一个例子，让我们看看部署一个网站，有数据库服务器、应用服务器、web 服务器和一个负载平衡器。通常，这些服务都是手动配置的，一个接一个，可能需要一个小时到几天的时间来解决所有问题并正常工作。

使用 Ansible，您可以创建一个行动手册(一组您希望在您的系统上完成的任务)，它将自动安装您的数据库服务器，设置您的 web 和应用程序服务器，并配置您的负载平衡器，而且每次都以相同的方式完成，更不用说它还比手动完成更快。最重要的是，它还可以确保所有这些服务运行正确的版本，不仅是你的网站，而且是你在后台运行你的网站所使用的程序。

感兴趣吗？厉害！让我们看看如何安装 Ansible 并创建我们的第一个剧本。

## 第一步:安装

注意:我假设你用的是 CentOS 7，如果你用的是另一个操作系统，你可以在这里找到 Ansible 的安装文档。

在您的 Ansible 主机上(可以是专用的 VM，或者您的笔记本电脑)，您可以通过 YUM 安装(如果您有 [Extras 通道](https://access.redhat.com/solutions/912213))，或者自己构建 RPM，或者使用 Python 的 pip 包管理器。我会告诉你如何通过 pip 安装。

确保您已经通过发行版指南安装了 python，然后执行:

```
$ sudo pip install ansible 
```

您已经准备好开始使用 Ansible 了。

## 第二步:撰写你的第一份行动手册

注意:Ansible 对它的文件使用 YAML，因此，空白对于语法非常重要。使用 Ansible 时，总是使用空格，而不是制表符。

注意:我在 Git 中保存了我的 Ansible playbooks，这个帖子对应的 repo 可以在这里 找到 ~~[。](https://git.justin-tech.com/ansible/yum_update)~~

1.  将一些主机添加到您的主机文件中:

全局主机文件位于`/etc/ansible/hosts`，用您喜欢的文本编辑器打开它，并添加您想要管理的一台或多台机器的 IP 或主机名

1.  创建一个新文件，通常在你的主目录或类似目录下。你想怎么叫都行，只要扩展名是。yml

概要如下:

```
---
- hosts:

  tasks:
  - name: 
```

这里有一个例子:

```
---
- hosts: all

  tasks:
  - name: install updates
    yum: name=* state=latest
    become: yes 
```

让我们把它分解一下。

首先，`---`是非常重要的，因为它需要是你创建的每个使用 Ansible 的 YAML 页面的第一行。

第二，`- hosts: all`，它指定您想要对 Ansible hosts 文件中的每个主机运行剧本。这可以在您运行行动手册时另外设置，因此不是强制性的。

第三，`tasks:`，这是一个标题，您将在此处填写行动手册中您想要完成的所有任务。这是这个级别的几个标题之一，Ansible 使用这些标题来了解在运行剧本的任何特定时间应该做什么。

第四，`- name: install updates`，这是任务的名称，也是定义多个任务的方式，因为每个任务都有自己的名称。

第五，`yum: name=* state=latest`，Ansible 能够使用 yum 和 Apt 包管理器将系统级包安装到受管计算机上，这一行将运行 Yum，查找系统上安装的任何包(`name=*`，其中*是通配符)，并确保状态是最新的。换句话说，它确保系统上的每个软件包都是最新版本，这与直接在系统上运行 yum update 是一样的。

第六，`become: yes`，告诉 Ansible 在运行任务时需要成为 admin 级别的用户(与运行 yum 或 apt update 时相同)。

既然我们已经编写了我们的第一个行动手册，是时候运行它了！

## 运行剧本

在远程系统上运行行动手册需要一些先决条件，概述如下:

1.  必须能够使用 SSH 登录到远程系统(这是最容易使用的 SSH 密钥)
2.  必须有权限作为管理员运行，特别是如果安装系统级软件包。您需要与直接对远程系统运行命令相同的权限

一旦满足了这些先决条件，您就可以运行下面的命令:

```
$ ansible-playbook <name_of_your_file>.yml 
```

假设您在文件的顶部添加了主机，您应该会看到输出，显示 Ansible 正在从远程计算机收集数据，然后安装更新。完成这些步骤后，您将看到一个漂亮的输出，显示任何问题或已更改的远程计算机的概述。请注意，在这种情况下，changed 意味着更新了一个或多个包。默认情况下，错误消息相当冗长，如果您遇到任何问题，它会告诉您到底哪里出了问题。