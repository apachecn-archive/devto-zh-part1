# 代码审查:健全性检查

> 原文：<https://dev.to/icambridge/code-review-sanity-checks>

在大多数情况下，对代码进行健全性检查是为了确保没有错误。出于这个原因，保证正确地完成健全性检查变得很有必要。如果你不检查数据是否有效，而它是无效的，那么你将允许无效数据继续。在这里，我将讨论我认为我们应该如何在 PHP 中进行健全性检查。

## 断言有效数据

我经常看到的是，人们在做理智检查时会断言无效数据。虽然这在逻辑上是有意义的，但是如果您知道数据是无效的，那么显然您希望在这一点上停止您的应用程序。

然而，我觉得我们应该做的是检查数据是否有效，而不是无效。在项目的整个生命周期中，数据失效的方式多种多样；但是，数据有效的方式保持不变，直到代码发生变化。

## 类型严格检查

这种方法的一个问题是它检查值是否为空；然而，在弱类型语言中，返回值可能是一个非空的值范围，但不是我们想要的正确值。这种情况会发生，尤其是在 PHP 中，开发人员习惯于在出错的情况下返回 false。因此，在某些时候，这个方法可能会返回 false，但仍然不是我们想要的值，这是很常见的。

### 下面是一些关于这个问题的示例代码:

```
<?php
$people = getNumberOfPeople();
if ($people === null) {
  exit(-1);
}
// do numeric logic 
```

Enter fullscreen mode Exit fullscreen mode

### 我认为应该这样做:

```
<?php
$people = getNumberOfPeople();
if (is_numeric($people) == false) {
  exit(-1);
}
// do numeric logic 
```

Enter fullscreen mode Exit fullscreen mode

对于第二个片段，我检查它是否不是数字。因此，我没有从我不想要的值开始，而是声明了我想要的数据类型，只有当我没有得到该类型时才会失败。通过这样做，我现在有了一个更通用的代码库，因为在一个开发人员期望为 null 的方法中返回 false 的小错误不会破坏应用程序。

## 物体检查

所以，我看到的另一个问题是，当人们想知道他们是否有一个有效的对象可以使用时，他们会检查是否返回了一个非真值。然而，这并不检查它们是否有一个值对象，可能的情况是它们有一个真正的值或者一个完全不同的对象不支持它们想要使用的契约。

### 下面是一些关于这个问题的示例代码:

```
<?php
$logger = getLogger();
if ($logger == null) {
  exit(-1);
} 
```

Enter fullscreen mode Exit fullscreen mode

### 我认为应该这样做:

```
<?php
$logger = getLogger();
if (($logger instanceof Logger) == false) {
  exit(-1);
} 
```

Enter fullscreen mode Exit fullscreen mode

所以，我没有检查我是否有一个对象或者一个真值，而是检查我是否有我想要使用的对象类型。这意味着，如果有人返回一个不同的对象类型，没有合同，然后我想使用代码失败，因为我们期望它。

## 其他方案

这些问题可以通过使用严格的类型和正确地分析代码来解决，这样，如果您将一个字符串注入到一个需要整数的方法中，您的构建就会失败。对于许多团队和项目来说，使用这些工具不是立即可用的，甚至是不可能的，所以如果您使用 PHP 7，启用严格类型，并在 strict 上运行 Etsy 的 Phan，那么您会自动发现许多这样的问题。

您仍然会遇到类型正确，但值不正确的问题。因此，在检查字符串值的情况下，是预期的字符串值之一，那么您需要检查该值仍然是您想要的排序，并且它不仅仅是一个空字符串。

## 开源项目

此外，有些人可能想知道为什么其他项目如 Symfony 不这样做。嗯，很简单:他们以另一种方式进行代码审查，并且他们确保他们的合同都是有效的，并且他们从不违反合同。因为他们所有的合同都有非常严格的文档记录和非常严格的审查，他们能够更加确信他们使用的代码不会改变。

您还需要记住合并一个平均拉取请求需要多长时间，以及有多少人审查它们。对开源项目的拉取请求可能需要几周时间才能被合并，并由几十个开发人员进行审查。然而，一般来说，在公司内部，拉式请求会持续几个小时或几天，并由一两个开发人员进行审查。在我看来，这增加了对这种防御性编程措施的需求。

还有一点，对于像 Symfony 这样的项目，如果一个契约没有得到支持，这是方法中的一个错误，返回了不正确的类型，这就是必须修复的地方。但是，对于内部应用程序，你不会那么关心 bug 在哪里；你首先关心的是你没有 bug。

## 结论

希望这解释了我们可以错误地进行理智检查的一些方法。重要的是要注意，这些健全性检查不仅仅是检查返回值，还设置类变量和其他需要进行健全性检查的地方的值。