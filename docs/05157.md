# 永恒改变了一切——帕特·海兰德

> 原文:[https://dev . to/mariosangiorgio/immutuability-changes-everything-pat-helland](https://dev.to/mariosangiorgio/immutability-changes-everything---pat-helland)

受到艾德里安·科尔耶的[晨报](https://blog.acolyer.org/)系列、[法比安·吉森](https://twitter.com/rygorous)的[我喜欢的论文](https://fgiesen.wordpress.com/category/papers/)帖子和我们喜欢的[论文](http://paperswelove.org/)讲座的启发，我决定开始写[关于我读过的](https://dev.to/tags/paper/)有趣论文的帖子。

Pat Helland 的[不变性改变一切](http://cidrdb.org/cidr2015/Papers/CIDR15_Paper16.pdf)描述了我们为什么需要不变性，以及如何在存储和计算能力使其变得负担得起的情况下采用它。

围绕不变性的关键概念是*仅追加计算*:观察到的事实被记录下来并永久保存，而从分析中得出的结果则根据需要进行计算。

### 这是新的吗？

有趣的是这并不是一个全新的概念。一个众所周知的例子是会计，它完全基于交易的附加记录。

> 会计不用橡皮，否则他们会进监狱。

电话出现之前的“分布式系统”是另一个历史例子。过去，消息被记录在由“仅附加”部分组成的表格中，因此所有参与者总是能够访问完整的消息历史。

### 数据集和大数据

本文将数据集定义为具有唯一标识符的固定且(语义上)不可变的数据集合。
在处理*大数据*时，不变性尤为重要。如果需要处理的数据量需要分布，唯一明智的处理方法是保证它不会改变。
这启用了*幂等函数计算*，它可以是分布式的，并且可以采用一种*让它失败的方法*:如果某个东西失败了，没关系，它将被重新启动。

重要的是要注意，不变性的要求是语义上的:只要我们不改变内容，我们就可以选择我们想要的方式来物理地安排数据。
这使我们能够以最有效的方式组织数据来完成任务，我们还可以对同一数据集进行多种不同的表示。

> 在为更新而设计的数据库中，规范化非常重要。规范化不可变数据集的唯一原因可能是减少它们的存储必要性。

### 不变性和不断发展的数据

有时我们希望跟踪一些数据的演变。我们可以用不变的方式做到这一点，但我们需要跟踪所有的变化。
一种方法是跟踪版本历史。
这可以通过一种非常一致的方式(*线性版本历史*)以一种最终一致的方式(*版本历史的有向无环图*)，就像你通常在 Git 中使用的那样。

版本控制技术也被用来提高数据库系统的性能。
用 [*多版本并发控制*](https://en.wikipedia.org/wiki/Multiversion_concurrency_control) 更新不覆盖现有数据。相反，他们创造了一个新的、孤立的版本。采用这种技术是为了允许不同的事务同时访问一个数据库，同时防止它们观察到不一致的数据。
一个[日志结构的合并树](https://en.wikipedia.org/wiki/Log-structured_merge-tree)通过将更改附加到日志中来记录更改。
这允许非常有效的插入，但是需要永久保存整个历史，并且会导致读取性能很差。
为了解决这个问题，定期压缩日志，删除重复项并重新组织数据以提高读取效率。

### 文件系统中的不变性

不可变数据也广泛应用于文件系统。
[日志结构文件系统](https://en.wikipedia.org/wiki/Log-structured_file_system)将磁盘视为循环日志。
这提供了非常好的写入性能(尤其是在磁盘上),并提供了快照和从崩溃中轻松恢复等功能。
当然，这不是免费的:随着磁盘变满，需要回收不再包含有用信息的块，为新数据腾出空间。

像 [GFS](https://en.wikipedia.org/wiki/Google_File_System) 和 [HDFS](https://en.wikipedia.org/wiki/Apache_Hadoop#HDFS) 这样的分布式文件系统利用不变性来实现高可用性。
文件由不可变的块组成，它们只有一个写入者。
通过这种设计，块级复制成为可能，无需担心更新异常。

### 分布式系统中的不变性

即使在使用一致哈希处理分布式数据存储时，不变性也能带来好处。如果数据是可变的，我们需要在重新平衡时满足于最终的一致性。有了不可变的数据，我们不需要担心不同节点中的陈旧版本。
如果一个节点有一些信息，那是它唯一会假设的值。

### 硬件设计

SSD 磨损平衡算法将块视为不可变的，并使用写入时复制在整个单元中更均匀地分布写入。
硬盘采用类似于日志结构文件系统的方法来实现不变性，从而提高性能并能够以更高的密度运行。

### 阴暗面

不变性非常有用，但它不是灵丹妙药。接受它需要我们做一些权衡。
反规格化增加了所需的存储量。
写入时复制会增加磁盘活动，这种现象称为写入放大。
在设计系统时，记住这一点很重要。

这篇文章最初出现在[我的个人博客](https://mariosangiorgio.github.io/post/immutability-changes-everything/)