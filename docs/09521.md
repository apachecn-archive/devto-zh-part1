# NPM 预包装和出版

> 原文:[https://dev.to/horia141/npm-prepack-and-publish-3d46](https://dev.to/horia141/npm-prepack-and-publish-3d46)

前几天我发布了一个小包给 [GitHub](https://github.com/horia141/npm-prepack-publish) 和 [NPM](https://www.npmjs.com/package/npm-prepack-publish) 。这篇文章作为文档和教程。

我想更好地控制 NPM 软件包中包含哪些文件。构建包的经典方法是调用 [`npm pack`](https://docs.npmjs.com/cli/pack) 。这包括当前目录下的文件，由`package.json`中的 [`files`](https://docs.npmjs.com/files/package.json#files) 字段控制。我的主要目标是让进口变得超级容易。但是很多时候当前目录的结构和`npm pack`的简单性导致了问题。

例如，我使用的一个常见目录结构是:

```
- package.json
- README.md
- src
  - index.ts
  - dependency.ts
- fonts # some data files
  - font.woff
- out # generated by the build process
  - index.d.ts
  - index.js
  - dependency.d.ts
  - dependency.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

这里有四种类型的文件。`src`中的源文件在源代码控制中。由于是 TypeScript，包的其他用户对它们不是特别感兴趣，所以它们不应该放在包里。像`package.json`这样的配置文件包含在包中，因为它们是 NPM 所需要的。包括额外的数据文件，如`fonts`目录中的文件。此外，包含整个目录是有意义的。最后，输出源文件，在`out`中应该包含在存档的根目录中。这样可以很容易地使用这个包:

```
import { foo } from 'my-package'
import { bar } from 'my-package/dependency' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

我们希望归档文件中的结构是:

```
- package.json
- README.md
- index.d.ts
- index.js
- dependency.d.ts
- dependency.js
- fonts
  - font.woff 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

不幸的是，`npm pack`展平了在`files`属性中指定的任何目录。所以它可以产生类似于
的东西

```
- package.json
- README.md
- index.d.ts
- index.js
- dependency.d.ts
- dependency.js
- font.woff 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

这个*在小范围内是*可行的。但过了一段时间，一个人注定会陷入困境。文件冲突可能会发生，磁盘上的结构和代码访问文件的方式是不同的，等等。

此外，在如下情况下:

```
- src
  - client
    - client.js
  - server
    - server.js
  - misc
    - misc.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

很难获得像这样的东西:

```
- client
  - client.js
- server
  - server.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

你必须在`files`中指定`src`，并以`misc`结束，或者`src/client`和`src/server`结束，并以扁平化的层次结构结束，这导致了与上面相同的问题。

为了解决这些问题，我写了`npm-prepack-publish`。它实际上是一个 bash 脚本，但是由于 NPM 脚本，它仍然很有用。它还完成打包和发布到 NPM，或者你设置的任何库`NPM_CONFIG_REGISTRY`。

在使用之前，需要设置`NPM_TOKEN`环境变量。实际上，使用它只是从命令行、CI 运行程序或其他地方调用`$(npm bin)/prepack-publish`的问题。一个例子是包本身的 [`.travis.yml`](https://github.com/horia141/npm-prepack-publish/blob/master/.travis.yml) 配置文件。

要配置如何构建归档文件，您需要在`package.json`中指定`filesPack`选项。这是一本字典，不像`files`。键是文件和目录，值是它们的打包方式。下面是原始示例的样子:

```
...
"filesPack": {
  "package.json": "f:package.json",
  "README.md": "f:README.md",
  "fonts": "c:fonts",
  "out": "e:."
}
... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

该配置将指示`pack-and-publish`将文件`package.json`和`README.md`原样复制到档案中，并将它们放在档案的根目录下。您可以将它们放在其他目录中，这些文件将被重命名，并更改它们的名称。`fonts`目录将被原样复制到存档中。最后，`out`中的内容将被展开并放在根目录中。输出将是:

```
- package.json
- README.md
- fonts
  - wont.woff
- index.d.ts
- index.js
- dependency.d.ts
- dependency.js 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

这正是我们想要的行为。尽管如此，我还是不知道是否应该把推和包装分开。也许人们会发现包装的效用。