# #讨论-微服务架构中的 API 级功能/集成测试

> 原文:[https://dev.to/brpaz/discuss-API-level-functional-integration-tests-in-a-microservice-architecture-4eh9](https://dev.to/brpaz/discuss---api-level-functional--integration-tests-in-a-microservices-architecture-4eh9)

你好。
考虑一个大约有 10 个微服务的项目，其中一些非常简单，没有外部依赖性，而另一些则更复杂，依赖于 2 或 3 个其他服务:

你将如何对每项服务进行 API 级别的功能/集成测试？

## 背景:

*   所有的服务都是由同一个开发团队开发的。(目前)
*   开发团队是一个普通的 scrum 团队(大约 5 个 API 开发人员)
*   现在，我们正在使用 Git 流的简化版本。(特征分支->开发->主)。最终目标是更接近 CI / CD 工作流程，但这需要时间。
*   在每个 PR 上运行单元测试和静态分析，如果失败就阻止合并。
*   涵盖关键用例的基本 E2E 前端测试集。

一些可能的方法:

对每个请购单进行测试？

对每个 PR 执行功能测试有意义吗？

在每个 PR 上运行测试将允许更早地检测问题，但是对于 ops 来说会更复杂，因为他们需要产生一个新的被测服务实例以及所有需要的依赖项，比如数据库。Kubernetes 之类的工具可以在这方面提供帮助，但这仍然是运营团队的额外工作。

我们可以使用数据固定装置或类似的东西来用测试数据填充数据库，但是关于服务依赖性呢？模仿依赖的服务，还是产生该服务的真实实例？

当您有许多依赖关系的服务时，第二个选项将更难做到，并且在每个 PR 上启动所有所需的基础架构也将是昂贵的，我相信我们应该能够单独测试每个服务。

对相关服务使用模拟允许单独测试每个服务，但不能保证服务之间的所有通信都正常工作，也不能保证不会对 API 响应带来任何重大变化。“合同测试”可以最大限度地降低风险。

在专用的“集成测试”环境中运行测试？

拥有一个运行所有服务的专用集成测试环境，以及一组应该与所有服务“兼容”的数据设备。从运营的角度来看，这很容易操作(只是一个新的环境),并且可以很容易地捕获配置错误，比如一个服务从其他服务指向一个错误的 url。

此外，它还允许检测服务响应中的重大变化，而无需进行契约测试。但是在这个场景中，我们用一组公共的数据一起测试所有的服务。我认为每个服务都应该能够被孤立地测试。

**两者的混合**

这可能是理想的解决方案，但是维护起来可能会更复杂，并且需要更多的时间来实现。

*   在每个 PR 上，生成一个被测试服务的实例，以及所有需要的数据结构(例如:数据库)

*   被测服务所依赖的服务应该被嘲笑。

*   进行合同测试以检测重大变更。

*   该测试的失败将阻止 PR 的合并，直到修复为止。

*   成功合并后，拥有一个集成测试环境，所有服务都在其中运行，并在那里运行测试。

在这个场景中，我的主要问题是如何在集成测试环境中处理数据设备。我不想让独立的功能测试和集成测试有不同的测试套件。对于这样一个小团队来说，维持成本太高了。

* * *

让我们开始讨论。你认为最好的方法是什么？

我知道功能测试和集成是不同种类的测试，可能两者都有意义(类似于第三个场景)，但是要记住约束。你认为应该优先考虑什么？功能性还是集成性？我们不是网飞，我们希望有尽可能简单的工作流程，这将使我们对 CI / CD 的最终目标更有信心。