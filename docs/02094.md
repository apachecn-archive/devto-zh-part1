# 我用了多少空间？？

> 原文:[https://dev.to/ferricoxide/ive-used-how-much-space-bhp](https://dev.to/ferricoxide/ive-used-how-much-space-bhp)

我的一个客户需要我帮助他们在 AWS 中实现一个完整的 CI/CD 工具链。作为实施的一部分，他们希望进行每日备份。小问题:他们的组织通常使用的企业备份软件在其 AWS 托管的开发帐户/环境中不可用。那个环境多半是“自己撑”。

幸运的是，AWS 有许多工具可以帮助完成备份任务之类的事情。客户对如何备份、保留期等没有明确的要求。只是“我们需要每日备份”。因此，我将一些基本的“将其注入 S3”类型的工作扔给他们，并警告说“您需要密切关注这一点，因为目前还没有数据生命周期元素”。

在最初的几个月里，一切都很顺利。然后，就像他们经常做的那样，问题开始出现。他们的备份作业开始出现周期性错误。无法找到潜在的原因。然而，在我四处寻找的过程中，我突然想到“不知道这些家伙是否像我警告他们的那样老化了他们可能想做的事情。”

AWS 在 S3 控制台中提供了一个漂亮的 GUI 选项，可以显示存储利用率。我快速看了一下他们在 S3 的后备仓库，发现“看起来不像”。

我不是一个很擅长 GUI 操作的人，我想要一些可以从 CLI 运行的东西，这些东西可以提供给带外通知程序。AWS CLI 提供了`s3api`工具集，对于这样的操作非常方便。我的第一次挖掘(和一些谷歌搜索)，我整理出“我如何获得这个桶的总利用率视图”。它看起来像这样:

> ```
> aws s3api list-objects --bucket toolbox-s3res-12wjd9bihhuuu-backups-q5l4kntxp35k \
> --output json --query "[sum(Contents[].Size), length(Contents[])]" | \
> awk 'NR!=2 {print $0;next} NR==2 {print $0/1024/1024/1024" GB"}'
> [
> 1671.5 GB
> 423759
> ] 
> ```

以上内容与 GUI 一致，并且比我假设的他们在这一点上使用的空间要大。所以，我想看看《我能打扫卫生吗》。

> ```
> aws s3api list-objects --bucket toolbox-s3res-12wjd9bihhuuu-backups-q5l4kntxp35k \
> --prefix Backups/YYYYMMDD/ --output json \
> --query "[sum(Contents[].Size), length(Contents[])]" | \
> awk 'NR!=2 {print $0;next} NR==2 {print $0/1024/1024/1024" GB"}'
> [
> 198.397 GB
> 50048
> ] 
> ```
> 
> “一天的备份量”也超出了预期。上次我对他们的备份进行普查时(今年夏天早些时候)，他们可能有 400 亿字节的数据。他们想要一周的备份。然而，在 200 gib/天的备份量下，我发现我真的无法削减利用率。这也意味着，也许他们一直在控制老化的东西。
> 
> _ 注意:是的，S3 有生命周期政策，允许您自动将东西转移到成本较低的层。不幸的是，自动分层(至少从常规 S3 到 S3 IA)的最短期限为 30 天。没用的，这里。_Saving grace:至少我找到了一种不用 web GUI 来验证 get 指标的方法。另一个副作用是，我有办法看到到达 S3 的数量与从他们的 CI/CD 应用程序中导出的数量相匹配。