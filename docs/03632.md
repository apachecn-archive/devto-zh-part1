# 简单明了的代码与性能

> 原文:[https://dev . to/Arne _ mertz/simple-and-clean-code-vs-performance-60d](https://dev.to/arne_mertz/simple-and-clean-code-vs-performance-60d)

*本文[原载](https://arne-mertz.de/2015/03/simple-and-clean-code-vs-performance/)在我的个人博客[“简化 C++！”](https://arne-mertz.de)。在近三年的时间里，大约 140 篇帖子，这是我写过的讨论最多、访问量最大的帖子。简化 C++！是一个关于现代 C++和干净代码的博客。*

C++的优势之一是可以编写非常高性能的代码。但是，这是否意味着我们总是要担心性能，并且尽可能地编写高性能的日常代码呢？我们应该为了性能而放弃简单吗？一定要吗？

# 我想并非如此

我认为我们不应该牺牲简单和干净的代码来编写更高性能的代码，原因有很多。相反，有人批评我提倡为了简单而牺牲性能。

我希望每个人都默认编写简单干净的代码。好吧，这很明显，因为这就是我的博客的全部内容。但是我为什么这么想呢？这里有一些。

## 性能不是效率

首先，有一点很重要。我们必须区分效率和性能，区别在哪里？简单来说，就是你做一件事有多快(性能)和做这件事需要多长时间(效率)。

乍一看，这听起来好像是一样的，但事实并非如此。想象你必须从 A 点到 b 点，效率意味着你走最短的路。性能意味着你跑而不是走。因此，如果你尽可能快地绕着整个街区跑去找你的邻居，你的表现很好，但效率不是很高。

在编程中，循环经常对程序运行时间有很大影响。这里，性能意味着单个循环周期执行得更快。效率意味着你必须做更少的循环，主要是因为你有一个更智能的算法。

有时候你不可能两全其美。更有效的算法的步骤可能性能较差。然而，在您试图从一段代码中挤出最后一点性能之前，请确保它是高效的。只有当你测试了效率方面的所有可能性，担心性能才是值得的。

> 有时，让您的代码更高效以获得期望的速度就足够了，而不必担心性能细节。

## 我们不需要到处都有性能

这一点显而易见，但是很多程序员，尤其是新程序员，往往会忽略这一点。论坛和 StackOverflow 上有大量的问题，询问如何优化某段代码。当有人反过来问代码是否真的是一个性能瓶颈时，结果往往是它不是。

有一种说法是，一个程序 80%的运行时间只花在 20%的代码里。有人说是 90/10。总的来说，确切的数字并不重要。关键的一点是程序在少量的代码中花费了大量的时间。

另一方面，这意味着大多数代码对总运行时间没有太大贡献，如果我们优化它，即使我们看到任何东西，也不会看到多少结果。

> 不要优化那些你还没有证明对整体程序性能至关重要的代码。

## 我们真的不知道如何编写性能代码

我知道，我怎么敢说那样的话。事实上，对程序运行时间的主要贡献之一是处理器必须执行的指令数量。而那些不是我们写的，是编译器和它的优化器写的。

优化器形形色色，除非你是这个领域的专家，否则你甚至无法猜测它们会对一段重要的代码做什么。优化器可以消除临时对象，可以内联函数，有时甚至在链接时，它们可以随意移动并消除大量这些指令。

那么，有了机器中的这些超能力，而我们完全不知道什么代码会给出最好的结果，我们能做些什么来使我们的代码更有性能呢？一开始，什么都没有。如果我们真的关心性能，我们不能依靠我们的想象力或经验，我们必须使用工具。

> 默认情况下，为了可维护性而编写代码，因为它可能和其他任何东西一样高效。如果您真的需要提高性能，请使用分析器。

当然，这并不意味着你应该过早地盲目乐观。如果有两种或两种以上的方法来编写一段可读性相同的代码，那么使用可能会产生最佳性能的方法。比如不保存表达式的结果就用`++iter`代替`iter++`，等等。

## 性能和简单并不总是相互矛盾的

对程序运行时间的另一个主要贡献，可能比指令的数量还要多，是内存中数据的布局和结构。Chandler Carruth 有一个关于通过使用正确的数据结构来获得更好性能的精彩演讲，所以我不会深入探讨。

我想说的是，如果数据的内存布局不好，运行时的大部分时间都花在从内存中获取数据和保存一些数据上，这些指令没有使用正确的数据结构产生的影响大。

> 在开始调整代码以获得更高性能之前，请确保使用性能最好的数据结构。

编写高性能的*和*简单代码还有另外一点:[使用你拥有的库，并正确使用它们](http://arne-mertz.de/2015/02/know-your-libraries/ "Know your libraries")——那些库的作者通常都很聪明，知道如何编写高性能的代码。他们特别知道如何使用他们的侧写器。

因此，如果您使用库而不是开发自己的解决方案，您的代码可能不仅更健壮、维护更简单，而且性能更高。

> 了解并使用您的库，除非您的分析器显示它们性能不佳。

# 结论

默认情况下，编写可读且简单的代码。如果您确实有一个性能问题，并且已经找到了它，那么仍然有许多选择比将您的代码变成一团乱麻更有希望。为了性能而牺牲简单性只是最后的手段，并且在处理性能问题的时候*总是*使用分析器。