# 应该先加密还是先压缩？

> 原文:[https://dev . to/app canary/should-you-encrypt-or-compress-first](https://dev.to/appcanary/should-you-encrypt-or-compress-first)

想象一下:

你在一家大公司工作。你的工作很无聊。坦率地说，你的才华被浪费在为一个应用程序编写样板代码上，这个应用程序的唯一用户是三个会计人员，他们看不到你。

你真正的激情是安全感。你每天阅读 [r/netsec](https://www.reddit.com/r/netsec) ，下班后参与 bug 奖金。在过去的三个月里，你一直在玩一个巴洛克式的股票交易游戏，你赢了，因为你发现了一个基于堆的缓冲区溢出，并编写了一些 AVR 外壳代码来帮助你挑选股票。

当你发现你所认为的视频游戏实际上是一个巧妙伪装的招聘工具时，一切都变了。世界上最好的安全咨询公司 Mont Piper 正在招聘——你刚刚获得了一次面试机会！

坐飞机和优步之后，你坐在你未来潜在老板的对面:一个有点汗流浃背的黑客，名叫加里，穿着挪威金属乐队的 t 恤，戴着他拒绝在室内脱下的太阳镜。

你很快通过了面试的第一部分。你很好地解释了隐私和匿名的区别。您非常详细地描述了同源策略，并给出了攻击者绕过它的三种方法。你甚至在白板上写下了`__fastcall`和`__stdcall`的错综复杂。最后，您到了倒数第二部分，协议安全性。

加里看着你的眼睛说:“你在设计一个网络协议。是先压缩数据再加密，还是先加密再压缩？”然后他双手合十，对自己微笑。

一个经典的安全面试问题！

* * *

花点时间好好想想。

在高层次上，压缩试图使用数据中的模式来减小数据的大小。加密试图以这样一种方式打乱数据，如果没有密钥，你根本无法在数据中找到任何模式。

加密产生的输出看起来是随机的:一堆含有大量熵的比特。压缩实际上对随机出现的数据不起作用——熵实际上可以被认为是一些数据“可压缩”程度的一种度量。

所以如果你先加密，你的压缩就没用了。答案一定是先压缩！就连 StackOverflow [也这么认为](http://stackoverflow.com/questions/4676095/when-compressing-and-encrypting-should-i-compress-first-or-encrypt-first)。

* * *

你开始对盖瑞说这句话，但是你说到一半就停了下来。嗅探加密流量的攻击者不会获得太多信息，但他们可以了解消息的长度。如果他们能以某种方式利用这一点来了解更多的信息，也许他们可以挫败加密。

你开始向加里解释，他打断了你——“哦，你是说像犯罪袭击那样？”

“是的！”你回复。你开始回忆它的细节。所有名字吸引人的 SSL 攻击在您的脑海中混杂在一起，但您非常确定就是它。他们控制服务器返回的一些信息，并使用这些信息来猜测响应中出现的秘密令牌。响应以这样一种方式压缩，您可以通过查看如何影响压缩消息的长度来验证对秘密的猜测。如果秘密是`AAAA`并且你猜了`AAAA`，压缩然后加密的响应将比你猜的`BBBB`短。

加里看起来印象深刻。“但是如果攻击者无法以任何方式控制任何明文呢？这种攻击还有可能吗？”他问道。

* * *

《犯罪》很好地展示了压缩然后加密并不总是正确的决定，但我最喜欢的压缩然后加密攻击一年前由安德鲁·m·怀特、奥斯汀·r·马修斯、凯文·z·斯诺和法比安·蒙罗斯发表。论文[加密 VoIP 对话的音位重构](http://www.cs.unc.edu/~fabian/papers/foniks-oak11.pdf)给出了一种从加密 VoIP 呼叫中重构语音的技术。

基本上，这个想法是这样的:VoIP 压缩不会是一个通用的音频压缩算法，因为我们可以依靠一些关于人类语音的假设来更有效地压缩。来自报纸:

> 许多现代语音编解码器基于一种众所周知的语音编码方案的变体，称为码激励线性预测(CELP) [49]，它又基于语音预测的源滤波器模型。源-滤波器模型将音频分成两个信号:由声带产生的激励或源信号，以及模拟由声道执行的声音成形的形状或滤波器信号。这允许音素的区分；例如，元音具有周期性激励信号，而摩擦音(如[sh]和[f]音)具有类似于白噪声的激励信号[53]。
> 
> 在基本 CELP 中，激励信号被建模为来自固定码本的条目(因此是码激励的)。在一些 CELP 变体中，例如 Speex 的 VBR(可变比特率)模式，码字可以根据输入帧的复杂性从不同的码本中选择；每个码本包含不同大小的条目。使用线性预测对滤波器信号建模，即，作为所谓的自适应码本，其中码本条目是过去激励信号的线性组合。“通过搜索可能码字的空间来选择来自每个码本的最佳条目，以便在被称为综合分析的过程中在感知上优化输出信号[53]。因此，编码帧由激励信号的固定码本条目和增益(系数)以及滤波器信号的线性预测系数组成。
> 
> 最后，许多 VoIP 提供商(包括 Skype)使用 VBR 编解码器来最大限度地减少带宽使用，同时保持通话质量。在 VBR 下，码本条目的大小以及编码帧的大小可以基于输入帧的复杂度而变化。安全 RTP (SRTP) [3]的规范不改变原始有效载荷的大小；因此，编码的帧大小在整个加密层中得以保留。因此，加密分组的大小反映了输入信号的属性；我们的方法正是利用这种相关性将音素建模为加密数据包的长度序列。

这基本上概括了这篇论文。CELP + VBR 意味着信息长度将取决于复杂性。由于线性预测的工作原理，需要更多的信息来编码声音中的剧烈变化——比如音素之间的停顿！这使得作者可以建立一个模型，可以将一个**加密的**音频信号分解成音素:也就是说，决定哪些音频帧属于哪个语音单元。

然后，他们建立了一个分类器，仍然只使用他们开始时的包长度信息，决定加密音频的哪些分段单元代表哪些实际音素。然后，他们使用语言模型来纠正上一步的输出，并将音素流分割成单词和短语。

疯狂的是，这整个繁琐的工作！他们使用了一种叫做流星的度量标准，得到了大约 0.6 的分数。这是一个<5 被认为“可以被人类理解”的规模考虑到这里的威胁媒介是使用这种技术监听您的加密 VoIP 呼叫的人——这真是太神奇了！

* * *

## 后记

通过严格的通宵文化契合度筛选后，你最终获得了这份工作。六个月后，Mont Piper 被卖给了一家大型企业集团。加里拒绝用他的挪威金属 t 恤换一件有纽扣的衬衫，因此被立即解雇。你现在整天去一家大银行现场，给一个恨你入骨的团队“出谋划策”。

但是最近，你已经学会了机器学习，并发现了这个非常酷的在线游戏，在这个游戏中，你试图让一个 6 条腿的机器人在 3d 物理模拟中行走...

*这篇[文章](https://blog.appcanary.com/2016/encrypt-or-compress.html)最初发布在 [Appcanary 博客](https://blog.appcanary.com)* 上。