# 被吊销执照；PKIX 中的证书状态检查

> 原文:[https://dev . to/dwd/licensed-revoked-certificate-status-checking-in-pkix](https://dev.to/dwd/licensed-revoked-certificate-status-checking-in-pkix)

## [](#once-upon-a-time)从前

很久以前，你有一份证书，所有的签名都正确无误，每个人都知道，无论是谁出示这份证书，他都将是真正的英格兰国王。你知道这些是因为你已经读过[关于 https 如何工作的简要说明](https://dev.to/ruidfigueiredo/briefish-explanation-of-how-https-works)。好东西。

但这并不完全正确。像 TLS 这样的证书所证明的是提交者可以访问私钥。那么如果别人获得了你的私钥会怎么样呢？

## [](#mitigations-against-compromise)缓和对抗妥协

比起没人理解的奇怪数学，安全人员更喜欢的是没人理解的长单词。真的，这些术语有着额外的含义。

“减轻”某件事意味着防止它，但要知道这种保护并不完美。“泄露”一个密钥意味着其他攻击者已经获得了它。“访问”密钥意味着能够直接使用密钥*或间接使用密钥*。

最后一句话可能听起来有点奇怪，所以让我解释一下——在大多数情况下，私钥保存在磁盘上的一个文件中。想签名什么，或者用它加密什么？将私钥加载到内存中，然后进行数学运算。如果有人想偷你的密钥，他们可以复制文件-你可能永远不会知道。

但事实并非如此。硬件安全模块会为你做数学运算，并给你结果——你根本无法从设备中取出私钥。这些东西出奇的便宜——一个简单的智能卡阅读器只要几美元。这意味着你的私钥现在是物理形式的，不能被复制。对于访问密钥的人来说，他们要么需要使用与智能卡插入的相同的物理硬件，要么窃取智能卡(在这种情况下，危害是非常明显的)。

## [](#compromised)妥协了

但是，如果您的密钥被(或可能被)泄露了，会发生什么呢？

首先，你需要告诉你的 CA，谁应该给你换一个证书。他们还“撤销”证书。太好了，但是其他人怎么知道呢？

我们知道，证书包含一堆东西，外加一个公钥。有些东西是人们如何检查它是否仍然可以使用的。有一些简单的东西，比如它是否在有效期内，但是也有两个 URL。

## [](#crldp)CRLDP

证书撤销列表分发点是一个 URL，我们可以通过它获得由证书颁发机构签署的撤销证书列表。它还有一个时间戳，表示下一个 CRL 将在何时生成，因此您可以将它缓存一段时间。这有点问题，因为这是一个时间快照——您无法判断在 CRL 的(可能)每日更新之间证书是否被撤销。这导致了潜在的检查时间、使用时间窗口。

尽管如此，CRL 还是很有用的，尤其是在只使用少量 ca 的社区中，因为折衷方案可以很好地缓存，而且代码很简单。

## [](#ocsp)OCSP

在线证书状态协议也是我们可以访问的一个 URL，这一次我们只需要获得这个证书的状态报告。这是一个及时、即时的检查，因此 TOCTOU 窗口基本上尽可能小。同样，它是签名的，并且有一个(通常很短的)到期窗口。

OCSP 和 CRLDP URLs 通常都是“http”，而不是“https”——这部分是因为响应本身是签名的，部分是因为否则会有一种先有鸡还是先有蛋的事情来试图弄清楚 https 服务器证书的状态...

但这确实意味着，如果你的网络浏览器使用 OCSP，攻击者(或者实际上是 CA 本身)可以准确地看到你试图验证的证书，从而知道你试图访问的网站。

## [](#stapling)装订

当然，只有当得到 OCSP 回应的东西实际上是你的网络浏览器时，那才是真的。OCSP 的回应不一定来自于此。名为“OCSP Stapling”的 TLS 扩展允许 web *服务器*进行查询，并在 TLS 握手中将响应与证书一起提交给 web 浏览器。

这意味着知道你正在访问网站的唯一实体是网站本身，这正是它应该的。

## [](#limitations)局限性

一个人必须知道自己的局限。——肮脏的哈利。

需要注意一些限制。

*   OCSP 装订仅适用于“终端实体”证书，而不适用于证书链中的任何证书。
*   OCSP 装订仅适用于服务器。web 浏览器也可以为用户身份验证提供证书，但这不受保护。

然而，在这两种情况下，CRL 都提供了实际的保护，除非 CA 本身受到了损害(在这种情况下，就安全性而言，我们正处于噩梦般的绿色场景中)。

## 所以我们都很好，对吗？

用基本速度换取安全的人，两者都不配。——本杰明·富兰克林。

必须说，本杰明·富兰克林在通信安全方面确实很糟糕，但尽管如此，谷歌、苹果和其他浏览器开发者真的把这一点放在心上，并且大多放弃了状态检查，因为他们更希望有速度。

例如，Google 维护着他们自己的“重要”证书列表。也不要费心去做 OCSP **或** CRL 检查了。一些网络浏览器默认尝试进行状态检查，如果失败(例如，URL 不可达)，他们就放弃。

有一种观点认为，对 OCSP 响应者的 DoS 攻击会导致大量网站不可用。对于 Twitter 甚至 dev.to 来说，这可能是一个合理的权衡，但可能不适合你的银行。虽然曾经有过总是检查证书的设置，但这些都被删除了。

然而，他们尽可能使用 OCSP 装订。

所以总结？如果你在做“你自己的”TLS，确保它在做某种状态检查。它会保护你免受一个罕见的，但非常严重的病例。OCSP 钉住在你自己托管的站点上相对容易，你应该这样做。最后，对于关键的私钥，尝试使用智能卡之类的硬件解决方案。