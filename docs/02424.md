# 当您的测试间歇性失败时会发生什么？

> 原文:[https://dev . to/bengreenberg/what-happens-when-when-your-tests-fail-intermittenly-4ej](https://dev.to/bengreenberg/what-happens-when-your-tests-fail-intermittently-4ej)

[![TDD](img/868091ccc806ad2e02186c654538627b.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--ZedduABB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ae50jbdry7gkccqulfp8.png)

我在 RubyConf 2017 上参加了许多演讲，其中一个真正增长了我的开发方法，是由 [Tim Mertens](https://twitter.com/rockfx01) 所做的题为 [*间歇性故障的确定性解决方案*](http://rubyconf.org/program#session-202) 的演讲。在他的演讲中，他定义了一些方法和工具，这些方法和工具可以在面对测试时使用，而这些测试只是偶尔会失败。的确，每次都失败的测试要简单得多。对于在测试驱动的开发环境中工作的开发人员来说，偶尔失败一次的测试是一个挑战。为什么这次失败了，而另一次没有？我如何缩小问题的范围？

蒂姆在讲话中首先提到的是“古怪测试的神话”。他挑战我们不要称我们的测试为“古怪”。一个古怪的测试意味着它是不可解决的。测试代码只做你告诉它做的事情。与其说它古怪，不如说它是不确定的，这恢复了我们解决这个问题的能力。最终可以解决非确定性测试失败的问题。如果我们只是简单地将真正困扰我们的测试标为*古怪的*，那么这可能会导致我们忽略它们，并且也忽略了测试试图为我们阐明的一个真正的问题。

如上所述，每次都失败的测试是最好的情况，因为它们是可重复的。它们可以在您的本地机器上运行，并产生完全相同的结果。测试失败的一些常见原因:

*   不新鲜的树枝
*   模拟时间与系统时间
*   缺少前提条件
*   您代码中的真正错误

当您的测试间歇性失败时，您会怎么做？

首先，尝试运行测试套件中的测试子集。直接运行`rspec`不是在测试组上运行测试，那是你的整个测试套件。运行`rspec ./spec/test_1`是在你的测试套件的一部分上运行一个测试，一个测试组。当你一个测试一个测试地运行你的测试时，你可以看到每个测试是如何分别响应的，这有助于你分解错误。

有时，您的测试会因为依赖问题而间歇性地失败。您可以使用 RSpec 中的`--seed`来重现测试运行的顺序。如果您返回许多错误，您可能希望在执行 RSpec 测试之前通过添加一个`--fail-fast`来缩小到第一个错误。

另一个非常强大的工具是`--bisect`命令，它重复地将测试集分成两半，直到找到导致另一个测试失败的最小测试集。您可以与`--seed`合作运行`--bisect`来重现测试顺序，并精确定位失败的测试组合。如果`--bisect`成功了，并且可以向您显示导致失败的测试的确切组合，那么您就有了一个*测试污染*的案例，即一个测试导致另一个测试失败。

你会如何处理测试污染？

很多调试测试污染归结为降低你的期望值。

要调试测试污染的情况，请看一下测试中的数据。数据是跨测试实例还是整个测试套件持久化的？你的测试应该会自动清理。然而，不要期望他们是原始的干净！例如，当构建测试时，不要期望`(User.count).to eq(1)`而是期望你正在测试的动作改变`(User.count).by(1)`。

类似地，不要期望全局范围的项目只返回测试记录。在构建测试时，考虑其他数据的可能性。另一方面，检查缓存，特别是类缓存和单体缓存。在任何修改缓存变化的测试之后，重置这些变化。然而，首先也不要在测试中改变缓存。最后，一个很好的地方是检查你的常数。尽量不要覆盖测试套件中的常量。

也许对 TDD 最常见的挫折是想继续下一个测试，或者如果幸运的话，通过所有的测试并继续下一个项目。然而，我们对进步的渴望不应该以花费时间来真正调试代码中的错误为代价。如果我们这样做了，我们可能会发现那些讨厌的“古怪的”测试会回来以我们本可以避免的方式困扰我们，如果我们立即解决它的话。

点击这里查看蒂姆的演示，并在 [Github](https://github.com/tmertens/intermittent_test_failures) 上查看他的例子。