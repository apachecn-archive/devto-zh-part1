# 当有疑问时，从底部重构

> 原文:[https://dev . to/ericnormand/when-duty-refactor-at-bottom](https://dev.to/ericnormand/when-in-doubt-refactor-at-the-bottom)

我最近参加了一个关于 JavaScript Jabber 的讨论。 [Aimee Knight](https://twitter.com/Aimee_Knight) 一直在阅读我关于抽象的文章，并问了一个非常尖锐的问题，我将转述如下:

> 你认为什么时候可以提取一个抽象概念？

我真的没有准备好回答这个问题。我本来想谈谈 ClojureScript。我试着问了这个问题，但是当然，在录音之后，我有了一个更好的想法去说什么。

重构代码的一种方法是寻找重复。您寻找相似的代码块，然后将公共部分提取到一个函数中。人们认为这种类型的重构支持“不要重复自己”的原则。他们称之为*干涸*你的代码。

代码枯竭已经变得如此普遍，以至于现在有人建议不要做得太多。桑迪·梅茨的建议很受欢迎:

> 复制比错误的抽象要便宜得多。

她的文章很好地解释了这些问题。去读吧。

情况是这样的:你看到十行代码和其他地方的十行代码几乎一样。他们在做类似的事情，你认为你可以把普通的部分提取到一个函数中，把不普通的部分作为函数的参数。你这样做，你的代码变得更短，你很高兴。

Metz 继续谈论后续影响，即有人想要重用该抽象，但需要这十行在一个方面有所不同，所以他们添加了另一个参数。参数随着时间聚合，直到代码变得一塌糊涂。

人们有不同的方法来减轻这一点。有人会说“等代码重复三遍再提取”。它更有可能被第四次使用，并且你更有可能在第一次捕获所有的参数。

这个方法[确实算作一个抽象](http://www.lispcast.com/what-is-abstraction)，因为你正在命名一个函数。这个名字当然是至关重要的。很多人说，如果你不能为你的抽象想出一个好名字，那它很可能不是一个东西。我很喜欢，但是命名很难。有时候我想不出一个好名字，当它真的是一个东西的时候。

但是还有一个更深层次的问题。实际上，我认为十行代码对于抽象来说太大了([梅斯同意](https://www.youtube.com/watch?v=npOGOmkxuio))。碰巧重复的十行代码不太可能有任何有趣的属性，包括无 bug、可重用和可组合，以至于您应该非常怀疑是否能够将整个事情作为常见的事情来考虑。但是，不要绝望！您经常可以找到许多 1 行、2 行或 3 行的代码。)易名而 2。)可重复使用。如果你把它们分解得足够多，当它们被你新的、小的抽象所取代时，你可能会开始看到那些重复的十行的一些潜在结构。

当人们问我“我如何重构它？”，这是我的第一反应。开始给小部分命名，即使它们没有重复。名字赋予你的代码意义。它组织你的代码和思维。即使命名的位永远不会被重用，附加一个名称仍然是有价值的。如果你从中得到一些再利用，那就太好了。

这个过程是一个纯粹机械的，几乎是统计性的寻找可重用性的方法。你在打赌小的抽象比大的抽象更有可能被重用。这是一个很好的赌注。然而，重构不能修复损坏的代码。它只能提高代码的质量，而不是其潜在的意义。

有时候这就是你想做的一切。你已经有了一些现有的代码。它工作了。你只想把它清理干净。那很好。这就像让你的桌子更整洁。你可以把文件叠得更整齐，整理好订书机和笔筒。扔掉旧可乐罐。你可以做所有这些事情，而不需要真正知道办公桌上做的是什么工作。

但是有时候你需要看看代码的意思，并在那个层面上真正做一些工作。如果你想把那些文件归档，你必须知道在哪里归档。你必须知道这篇论文是关于什么的，为什么你会有它。我们需要这个订书机吗？可能干这行用不上？也许它需要一个更长的订书机。我们需要更多地了解那个订书机在工作中的意义。

在这一点上，简单的关于某件事情重复了多少次或者提取了多少行代码的度量标准是不够的。事实上，简单地提取现有代码根本不会削减它。我们需要更深入地了解我们要做的事情，并找到那里的结构——而不是在我们的代码本身。当你到了那一步，就没有什么建议了。这是我发现/创造的。

*   [领域驱动设计](https://en.wikipedia.org/wiki/Domain-driven_design)是一种与领域专家一起开发代码的方法，以真正了解抽象的“是什么和为什么”。
*   [指称设计](https://www.youtube.com/watch?v=bmKYiUOEo2A)是一种使用范畴理论深入思考抽象的方法。
*   构建可组合的抽象概念是我试图阐述一个不需要复杂数学的抽象设计过程。它严重依赖你对物理系统的直觉，尽可能拖延编写代码。

我欣赏这些方法，因为它们迫使我们以更深的方式重新审视这个领域。

## [](#conclusions)结论

代码中的重复可能是一种迹象，表明代码中潜伏着一种抽象，随时可以被提取出来。虽然标志可能很清楚，但我们并不总能确定如何最好地提取它。如果你不确定，不要提取它。抽象越长，就越有可能不可重用。但是重复码的每十行比特有九个两行比特和八个三线比特。那里可能有可以提取的东西。从那里开始，用更小的抽象。从底层开始重构！最后，重构是有限制的。有时你需要重新审视你的抽象的意义，而不仅仅是当前的代码。

如果你对计算机科学的伟大思想和编程的哲学问题感兴趣，你应该看看 [PurelyFunctional.tv 时事通讯](https://purelyfunctional.tv/newsletter)。这是一个关于 Clojure 和函数式编程的理论和实践的每周游戏。