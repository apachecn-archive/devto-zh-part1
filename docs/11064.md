# Chris Seaton 用 JRuby+Truffle 大幅度提高 Ruby 性能

> 原文:[https://dev.to/ben/chris-seaton-making-ruby-fast](https://dev.to/ben/chris-seaton-making-ruby-fast)

Ruby 因其自然的语法和通过元编程和猴子补丁提供的灵活性而在编程社区中广受欢迎。Ruby 的大部分吸引力都集中在开发人员的体验上，虽然它提供的自由可能会导致一些令人毛骨悚然的情况，但这种吸引力经受住了时间的考验。Ruby 不被认为是一个快速的。对于典型的应用程序来说，它通常已经“足够快”了，但是在某些情况下优化 Ruby 可能是一个大问题。

这就是克里斯·西顿的用武之地。他和他在[甲骨文实验室](https://labs.oracle.com)的团队正在开发一个名为 [JRuby+Truffle](https://github.com/jruby/jruby/wiki/Truffle) 的 Ruby 实现，作为当前 Ruby 实现套件的替代方案，它提供了一些大规模的性能升级。在最近的更新中，Chris 宣布该实现的基准测试速度比 MRI 快 31 倍以上。这位实用的开发人员联系了 Chris，以了解关于这个项目的更多信息，以及我们对下一年的期望。

## 解释使 JRuby+Truffle 成为可能的技术

在某些方面，JRuby+Truffle 在概念上是 Ruby 最简单的实现。和其他实现一样，我们做的第一件事是将 Ruby 源代码解析成抽象语法树(AST)。与其他实现不同，这是我们所能做到的——在 JRuby+Truffle 的实现中，没有字节码或程序的其他表示。然后我们通过遍历 AST 来执行您的程序。例如，如果您有一个`Fixnum#+`节点，我们执行左右值的两个节点，然后执行结果。这就像访客模式，如果人们熟悉的话。

我们用 AST 做了一个新的技巧——我们在程序运行的时候专门化它。例如，我们有一个“call”节点，它第一次运行时，我们会看到调用了什么方法，然后对该调用节点进行特殊化，以便在下次运行时调用相同的方法。Truffle 是 Java 框架和 DSL 的名字，它帮助我们编写这样的 AST 解释器。

我们获得的巨大性能提升来自于 Truffle 使用这个简单的 AST 解释器所做的事情。我们已经为 Java 编写了一个新的 JIT 编译器 Graal。它本身是用 Java 编写的，这意味着它可以被用作 Java 库。Truffle 使用 Graal 将我们的 AST 解释器编译成机器码，这相当于为我们自动完成了其他实现中的所有阶段。

Graal 正在推进跨所有语言的 JIT 的最新发展，并包括一些非常强大的优化，这些优化对 Ruby 代码产生了很大的影响，例如*部分求值*，它允许我们在编译时运行 Ruby 程序的一部分，以及*部分转义分析*，它允许我们虚拟地创建 Ruby 对象，但永远不会真正地`malloc`它们。

例如，如果你写一个 max 方法作为`[a, b].sort[1]`，局部转义分析将会看到，尽管你创建了一个数组并对其进行排序以创建另一个数组，但是这些对象对其他人都是不可见的，所以它们实际上不需要被分配，并且局部求值将会在编译时尽可能地运行排序和索引，而实际上并不知道这些值。结果就是这个方法会被编译成类似`if a > b; a; else b`的东西。

这种优化对于提高习惯性 Ruby 代码的性能非常有效，这种代码经常使用大量临时对象和抽象。我们将它们与一种叫做*动态去优化*的技术结合起来，如果一个方法被猴子修补，或者有人使用了`ObjectSpace.each_object`或`Kernel.binding`，这种技术可以逆转优化。

## 当 JRuby+Truffle 被认为对于现实世界的使用来说足够高性能和完整时，哪些类型的用户和项目会成为最好的早期采用者呢？

我们正开始进入这样一个阶段，没有本机代码和不使用标准库某些部分的简单 gem 和应用程序，如 [openssl](https://www.openssl.org/) 可能能够运行。像[韦布里克](http://ruby-doc.org/stdlib-1.9.3/libdoc/webrick/rdoc/WEBrick.html)、[辛纳特拉](http://www.sinatrarb.com/)和[积极支持](https://github.com/rails/rails/tree/master/activesupport)这样的瑰宝已经开始发挥作用。在 2016 年期间，我们将让 Rails 堆栈的其余部分或多或少地工作，并且我们将测试其他重要的宝石。

因此，最早受益的人是那些具有最简单依赖集的人和那些不使用本机代码的人。比如小的 Sinatra 应用。如果他们在 Ruby 内部进行大量的处理，他们将会看到最大的影响。我们正在对处理图片的应用程序进行基准测试，比如用[矮胖的 PNG](https://github.com/wvanbergen/chunky_png) 进行测试，并看到了巨大的收益。

## 你认为水晶语言的方法怎么样？

我相信 [Crystal](http://crystal-lang.org/) 的想法是创造一种比 Ruby 更简单的新语言，并且没有难以静态优化的特性。例如，它不支持像`#send`或`#eval`这样的方法。

Crystal 是一种有效的方法，它看起来像是在为他们想要做的事情而工作，但它可能对使用现有 Ruby 应用程序的人和想要使用现有 Ruby gems 的人没有帮助，因为真正的 Ruby 代码会大量使用这些功能。如果没有这些方法，很难想象像 Rails 这样的东西。这确实是一种新语言，看起来和感觉上很像 Ruby，但不足以运行现有的 Ruby 代码。

我认为如果我们为了实现性能而不得不放弃这么多 Ruby 的特性，那将是一种耻辱。如果我们能在不移除特性的情况下让 Ruby 变得更快，那么我认为这对 Ruby 程序员来说肯定是更好的选择。

Crystal 确实有其他有趣的优点，比如宏和小尺寸。

## 是 Ruby 的什么让你想承担这个项目，对 Ruby 的未来有什么样的影响？

我实际上是作为一个实习任务被交给这个项目的。在我开始使用 Ruby 之前，我从未写过或读过一行 Ruby，所以我在从英国飞往旧金山的航班上读了几本 Ruby 书籍，然后我使用 Ruby 的第一天就是我开始实现它的第一天。

但是在开始使用 Ruby 语言和社区后，我真的爱上了它的方方面面。它绝对是一种多产的语言，我喜欢编写 Ruby 程序，我认为让它变得更快是最后的难题之一，所以我很自豪能致力于此。

你会看到许多语言实现者取笑他们试图实现的语言——说他们在某些地方有多疯狂，代码有多糟糕。我试图采取一种哲学的方法，对 Ruby 是如何设计的不发表意见。我将尝试实现 MRI 所做的一切，并且我很高兴尝试让任何人的代码快速工作，不管它使用什么语言特性或者它的设计多么低效。出于这个原因，我不想提供任何关于如何改进语言本身的想法——我认为这是其他人的单独工作。

当然，最终我希望 JRuby+Truffle 有一天会成为人们想要使用的实现，因为它速度更快，工具更好。我认为它将会带来的影响是表明 Ruby 性能的上限比之前认为的要高得多。像 Evan Phoenix 这样的人已经在谈论 JRuby+Truffle 能做什么，并说这是 MRI 应该瞄准的目标。

## Oracle 目前对开源技术的态度是什么？这个项目会受到什么影响？

甲骨文正在维护[大量重要的开源项目](http://www.oracle.com/us/technologies/open-source/overview/index.html)，包括 [MySQL](http://www.oracle.com/us/products/mysql/overview/index.html) 、 [OpenJDK](http://openjdk.java.net/) 和 [VirtualBox](https://www.virtualbox.org/) 。

开源我们在 Ruby 上的工作并集成到现有的 JRuby 项目中，是让代码尽快变得有用的显而易见的方法。JRuby 团队非常欢迎并成为这样一个社区的一部分，这使得这项工作很有趣。我们甚至从社区里雇佣了几个人全职和我们一起工作。

我们使用了与 JRuby 相同的许可证，而不是强加我们自己的许可证，以获得最大的兼容性，Truffle 和 Graal 也是开源的，并在 OpenJDK 上工作，所以你需要运行 JRuby+Truffle 的完整堆栈是开放的。