# 在网络应用上“没有人会离线”——或者我们会吗？

> 原文:[https://dev . to/active node/nobody-goes-offline-on-web-apps-or-do-we-2130](https://dev.to/activenode/nobody-goes-offline-on-web-apps-or-do-we-2130)

### “没有人会离线”——或者我们会离线吗？

### TL；博士；医生

这篇文章是关于现代 web 应用程序中的服务人员和架构的，包括对以下陈述的考虑。

> “没有人离线[……]只有间歇性”
> 
> [ [李·拜伦](https://medium.com/u/d9b1a61823fa)，脸书，#FullStackFest 2016]

在 2016 年巴塞罗纳全栈节上， [Lee Byron](https://medium.com/u/d9b1a61823fa) 谈到了 [*不可变用户界面*](https://www.youtube.com/watch?v=pLvrZPSzHxo) 以及 MVC 等现有架构的问题。这是一个关于我们如何在前端构建更好的架构的演示。

试图用很少的词来总结:

> 在前端使用高级查询语言来检索数据(REST 确实不能很好地处理关系和子查询)，并构建基于状态的前端应用程序，这些应用程序可以累积状态，而不是消除旧状态并用新数据覆盖(这将是 MVC btw)。为什么？因为这允许你有一个所谓的**乐观状态，你可以在得到服务器响应之前应用，并在服务器响应失败时回滚。**

 **好的，李是脸书的工程师，所以用脸书的术语来翻译就是:使用 **GraphQL** 和 **React** ， **Redux** ，避免让用户对加载程序感到沮丧。到目前为止，一切顺利。

### “无人下线”

他的意思是:没有人愿意离线说“我真的想马上切断我的互联网连接”——这是真的。

[![](img/70f3793f2a5e4c1c99f0e640c8edb4f7.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--eZQGbYCh--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/498/1%2AjYRduQTXaiw2wUSHsZ9WDQ.png)

现在看看像 Twitter、脸书、易贝、Pinterest 等著名平台。在所有这些平台上，我们可以假设用户最多有“长间歇”，但不愿意离线。所以从这个角度来说“没人下线”的说法可以得到证实。

### 我构建了一个离线数小时的 PWA 网络应用程序

在我正在做的一个项目中，我和 nodus medical GmbH 的人一起工作。这些人来自空军和外科医生，他们要求我建立一个 MVP 来提高医疗领域的效率。

现在，让我们不谈这个应用程序做什么，而是谈谈需求/环境以及如何解决问题。**用于互联网连接几个小时部分不可用或由于安全原因不允许的领域。**所以你可以说用户至少在知情的情况下*离线*。

#### 明知故犯下线有什么问题？

1.  如果您缺少像未缓存的模板这样的资产，应用程序的这一部分将不可用
2.  拥有临时的(非持久的)乐观状态是在你离线时丢失数据的一种简单方式(无意的重新加载，平板电脑操作系统崩溃等等)
3.  试图每次都与服务器同步是没有意义的(尽管从性能的角度来看这很便宜，但仍然是没有意义的，因为应用程序知道这不仅仅是几秒或几分钟的事情)
4.  处理两种类型的数据:同步数据和非同步数据—包括建立非同步数据和同步数据之间的关系。这听起来似乎很容易，但是让我们在相应的章节中更深入地探讨一下。

#### 1。缓存所有资产

有人说*离线优先*是指在互联网连接中断时提供一种使用网站/应用的方式。我称之为*离线特色*。另一方面，离线优先是让应用程序离线工作，然后提供一种连接到网络的方式。

是服务人员。我使用[缓存](https://developers.google.com/web/fundamentals/getting-started/primers/service-workers)并告诉软件我的应用程序需要哪些资产才能运行。在我的情况下，我希望整个(Angular)应用程序离线工作，所以我需要缓存懒惰加载的模板(partials)。**酷，那很容易**。

#### 2。持久和安全的数据:使用 IndexedDB

如上所述，当你知道用户至少会离线一个小时时，我不认为使用临时状态是个好主意。因此，如果你像我一样，喜欢构建自己的抽象层，你可以使用 [Dexie.js](http://dexie.org/) (类似 SQL 的前端查询)。如果你使用 Redux，你可以在网上搜索一个允许 Redux 持久存储的扩展。

对于我的项目，整个数据库必须在前端可用，所以在前端使用 Dexie“本地数据库优先”也是有意义的。也就是说:当用户请求数据时，我甚至没有试图从服务器获取数据。一切都在本地完成。

*BTW，如果你现在想到 web SQL:*[*它死了*](https://dev.w3.org/html5/webdatabase/) *。*

#### 3。正在尝试与服务器同步。BackgroundSync？

因此，我们缓存了所有资产，并将所有数据保存在本地。但是我们仍然需要与服务器同步，以确保其他设备也可以访问这些数据，并进行冗余备份。

ServiceWorkers 实现了一个 API，它被广泛地称为 **BackgroundSync** ，但是存在于。同步。还有一个[类似的 API](https://developer.mozilla.org/en-US/docs/Web/API/PeriodicSyncManager) 叫做。periodicSync 实现了类似的行为，但是是周期性的。

[Sync](https://dbwriteups.wordpress.com/2015/11/16/service-workers-part-3-communication-between-sw-and-pages/) 可让您将数据发送给维修人员，然后在互联网连接允许的情况下尽快进行处理。假设您创建了一个聊天应用程序，并希望所有消息都尽快出现在服务器上，这非常方便。假设您已经实现了一个 ToDo-List，您甚至可能想要定期检查和比较您的数据。

但是你把决策权交给了浏览器。例如，您的同步可能因为电池容量或因为其他进程具有更高的优先级而延迟。[浏览器也可能决定不再尝试同步](https://wicg.github.io/BackgroundSync/spec/#dom-syncevent-lastchance)。

> 如果考虑到失败和延迟的发生，BackgroundSync 是非常有用的。必须知道它在后台做什么。当您想要在 FE 中实现同步的主动控制时，情况会更复杂，因为必须在软件和 FE 之间建立通信通道。

在我的 ServiceWorker 应用程序中，同步 API 不能提供额外的商业价值，所以我放弃了使用它们。这是因为 UX 要求同步必须有意识地进行。唯一可以做的事情是允许用户点击同步按钮，离开应用程序，并在同步完成时通过通知让用户知道。但是，同样地，你甚至不需要同步 API 来完成这个任务，只需要获取 ServiceWorker 即可。

#### 4。欢迎来到搏击俱乐部:同步与非同步数据

构建一个真正离线优先的应用程序如果你不考虑数据如何同步，你很容易遇到麻烦。

如今，许多 iOS/Android/Web 应用程序只会显示一个锁定应用程序的对话框，如下所示:

> 哎哟，你下线了。请再次联机。

这是一个简单但令人讨厌的避免冲突的技巧。但是，如果您希望允许多个不同的用户离线操作数据，那么如果在您的体系结构中没有注意到这一点，您就很容易破坏您的数据。

如果你知道 *Git 合并冲突*你就已经知道解决方案了。不要覆盖服务器上的任何数据，而是给他们一个完整的历史记录(用户、时间、接受时间等等)，然后允许正在同步的人通过选择想要的项目来解决 UI 中的冲突。

### 总结

随着网络应用部分取代本地应用，出现了真正的离线优先应用。我们可以利用 Sync 接口进行数据同步，利用 IndexedDB 进行复杂存储。通过让数据离线进行管理，但出于备份和同步的原因让数据留在服务器上，您分散了数据，这导致了*多个事实点*。这必须通过版本控制来解决。**