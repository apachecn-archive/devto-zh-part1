# 关于 AWS 网络，您需要了解的一切

> 原文:[https://dev . to/grahamlyons/everything-you-need-know-on-AWS-4bkf](https://dev.to/grahamlyons/everything-you-need-to-know-about-networking-on-aws-4bkf)

# 关于 AWS 网络，你需要知道的一切

声明:我不是网络工程师，从来都不是——为了确保事实和术语的准确性，我们咨询了一位温顺的网络工程师。以下是我从在亚马逊网络服务上构建和使用网络基础设施中学到的一切。如果你发现你没有这个信息的参考点，那么就在 AWS 控制面板的“VPC”部分戳一下(或者联系告诉我我在胡说八道)。

## 你应该了解的网络部分

如果你在 AWS 上运行基础设施和应用程序，那么你会遇到所有这些事情。它们不是网络设置的唯一部分，但以我的经验来看，它们是最重要的部分。

### VPC

虚拟私有云- VPC -是一个私有网络空间，您可以在其中运行您的基础架构。它有一个您可以选择的地址空间(CIDR 范围)，例如`10.0.0.0/16`。这决定了您可以在 VPC 内分配多少个 IP 地址。您在 VPC 中创建的每台服务器都需要一个 IP 地址，因此该地址空间定义了您在网络中可以拥有的资源数量限制。`10.0.0.0/16`地址空间可以使用从`10.0.0.0`到`10.0.255.255`的地址，即 65536 个 IP 地址。

VPC 是您在 AWS 上的网络基础，所有新帐户都包括一个默认 VPC，每个可用性区域都有一个子网。

```
+---------------+
|     VPC       |     The Internet
|               |
|               |
|  10.0.0.0/16  |
|               |
|               |
+---------------+ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### 子网

子网是 VPC 的一部分，有自己的 CIDR 范围和流量流动规则。它的 CIDR 范围必须是 VPC 的子集，例如`10.0.1.0/24`将允许从`10.0.1.0`到`10.0.1.255`的 IP 提供 256 个可能的 IP 地址。

子网通常被命名为“公共”或“私有”，这取决于流量是否能从 VPC(互联网)之外到达它们。这种可见性由流量路由规则控制，每个子网可以有自己的规则。

子网必须位于一个区域内的特定可用性区域中，因此在每个区域中都有一个子网是一种很好的做法。如果您计划拥有公共和私有子网，那么每个可用性区域应该有一个。

```
+---------------------------+
|            VPC            |
|                           |
+------------+ +------------+
||  Subnet 1 | |  Subnet 2 ||
||10.0.1.0/24| |10.0.2.0/24||
||           | |           ||
|------------+ +------------|
+---------------------------+ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

#### 可用性区域

我们说过每个可用性区域应该有子网，但这实际上意味着什么呢？

每个 AWS 区域被划分为两个或更多不同的区域，这些区域旨在保证该区域的高可用性。本质上，至少一个区域应该能够运行，即使其他区域遭受中断(🔥).

```
+----------+          +----------+
|us-ea)t-1a|          |us-east-1b|
|_____(____|          |__________|
|     )    |          |          |
|   ( &()  |          |    ✔     |
|  ) () &( |          |    8-)   |
+----------+          +----------+ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### 路由表

路由表包含有关子网中的 IP 数据包如何到达不同 IP 地址的规则。始终有一个默认路由表，它只允许流量在 VPC 内本地传输。如果子网没有与之关联的路由表，则使用默认路由表。这些将是“私有”子网。

如果您希望外部流量能够到达子网，那么您需要创建一个路由表，其中包含明确允许这样做的规则。与该路由表相关联的子网将是“公共”的。

默认 VPC 中的所有子网都与一个路由表相关联，路由表使它们成为公共的。

### 互联网网关

使子网成为公共子网的路由表需要引用 Internet 网关，以允许外部 IP 数据包流入和流出 VPC。您创建您的互联网网关，然后创建一个规则，规定发往`0.0.0.0/0`(所有 IP 地址)的数据包需要到达那里。

```
 Route table
         +-------------------+
         | 10.0.0.0/8: local | Requests within the VPC go over local connections.
      +--+ 0.0.0.0/0: ig-123 | Requests to any other IPs go via the Internet Gateway.
      |  |                   |
      |  +-------------------+
      |
      |
+-----+-------+          +-------------+
|  Subnet 1   |          |  Subnet 2   |
| 10.0.1.0/24 |          | 10.0.2.0/24 |
|             |          |             |
|             | 10.0.2.9 |             |
|             +--------->|             |
|             |          |             |
+-------+-----+          +-------------+
        | 8.8.4.4
        |
        |   +--------+
        +-->| ig-123 |
            |        +-----> The Internet
            +--------+ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### NAT 网关

如果你有一个 EC2 实例在一个私有子网中——一个不允许来自互联网的流量到达它的子网——那么 IP 包也没有办法到达互联网。我们需要一种机制来发送这些数据包，然后正确地路由回复。这被称为网络地址转换，很可能是在你家通过你的 wifi 路由器完成的。

NAT 网关是一种位于公共子网中的设备，它接受来自私有子网的发往 Internet 的任何 IP 数据包，将这些数据包发送到它们的目的地，然后将返回的数据包发送回源。

如果您不想让专用子网中的实例通过 VPC 与外部通信，则没有必要使用 NAT 网关，但是如果您确实需要这样做，例如使用外部 API、SaaS 数据库等。然后，您可以简单地设置一个 EC2 实例(可能更便宜，取决于您的流量)，进行适当的配置，或者使用 AWS 管理的 NAT 网关资源(将更容易管理，因为您不需要这样做)。

```
 +---------------------+
  |   Public Subnet     |
  |   10.0.1.0/24       |
  |                     |
  |    +------------+   |
  |    |            +----------->   The Internet
  |    |  nat-123   |   |
  |    |            |   |
  |    +-------^----+   |
  |            |        |
  +------------|--------+
               |
               | 8.8.4.4
               |                       Route table
  +------------+---------+    +---------------------+
  |  Private Subnet      +----+  10.0.0.0/16: local |
  |  10.0.20.0/24        |    |  0.0.0.0/0: nat-123 |
  |                      |    +---------------------+
  +----------------------+ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   公共子网包含 NAT 网关
*   从私有子网向互联网上的某个 IP 地址发出请求
*   路由表显示它需要到达 NAT 网关
*   NAT 网关将它发送出去

### 安全组

VPC 网络安全组表示哪些流量可以流入(流出)VPC 内的 EC2 实例。安全组可以指定入口(入站)和出口(出站)流量规则，将它们限制在特定的来源(入站)和目的地(出站)。它们与 EC2 实例而不是子网相关联。

默认情况下，允许所有流量流出，但不允许任何流量流入。入站规则可以指定源地址(CIDR 块或另一个安全组)和端口范围。如果源是另一个安全组，则必须在同一个 VPC 内。例如，使用默认安全组创建的 VPC 允许来自具有相同安全组的任何设备的流量。将该组分配给 VPC 中创建的所有资源(不一定是最安全的做法)意味着所有这些资源都可以相互对话。

```
 +---------------+
                   | sg-abcde      |
                   | ALLOW TCP 443 |
                   +----+----------+
                         |
                    +----+------+
                    |  i-67890  |
 10.0.1.123:22      |           | 10.0.1.123:443
----------------------->X|           <----------------
                    |           |
                    +-----------+ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

*   一个实例(i-67890)有一个安全组(sg-abcde ),它允许端口 443 上的 TCP 流量
*   在端口 22 上向其 IP 地址(10.0.1.123)发出了一个请求，但该请求没有通过
*   向实例上的端口 443 发出请求，流量被允许

## 把所有的东西放在一起

虚拟专用网络的完整情况如下图所示，公共和专用子网分布在可用区域中，网络地址转换位于公共子网中，路由表指定数据包的路由方式。EC2 实例可以在任何子网中运行，并且有安全组连接到它们。

```
 +-------+                                  
                                        | ig-1  |                                  
                                        |       |                                  
        vpc-123: 10.0.0.0/16  |         |       |        |                         
       +----------------------+---------+-------+--------+---------------------+
       |                      |                          |                     |   
       |  +-----+             |  +-----+                 |  +-----+            |   
       |  | NAT |             |  | NAT |                 |  | NAT |            |   
public |  |     |             |  |     |                 |  |     |            |   
subnets|  +-----+             |  +-----+                 |  +-----+            |   
       |                      |                          |                     |   
       |                      |                          |                     |   
       |                      |                          |                     |   
       |              +-------+                  +-------+             +-------+
       |              | rt-1a |                  | rt-1b |             | rt-1c |
       | 10.0.1.0/24  |       | 10.0.2.0/24      |       | 10.0.3.0/24 |       |   
------------+-----------------------------------------------------------------------+
       | 10.0.4.0/24  | rt-2a | 10.0.5.0/24      | rt-2b | 10.0.6.0/24 | rt-2c |
       |              |       |                  |       |             |       |   
       |              +-------+                  +-------+             +-------+
private|                      |                          |                     |   
subnets|                      |                          |                     |   
       |                      |                          |                     |   
       |                      |                          |                     |   
       |                      |                          |                     |   
       |                      |                          |                     |   
       |                      |                          |                     |   
       |                      |                          |                     |   
       +----------------------+--------------------------+---------------------+
       |         AZ 1         |          AZ 2            |        AZ 3         | 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>