# 手机游戏中的地理定位

> 原文:[https://dev.to/netcell/geolocation-in-mobile-game-j02](https://dev.to/netcell/geolocation-in-mobile-game-j02)

# 🖼️概述

一般问题如下:

> 在一组预定义的记录中为游戏提供玩家在特定区域内的上下文，从而允许游戏相应地影响玩家的过程。

🗒️在这里，一个`location`被理解为一组两个值`(latitude, longitude`，它们指的是地球表面上的一个位置。

# 🛒市场上有什么？

## 🎮地理定位游戏

**🔴 🌐** [**地理藏宝**](https://www.geocaching.com/play)

这款游戏于 2000 年推出，至今仍运行良好，它允许玩家去寻找真正的盒子📦藏在世界各地。虽然⚽更像是一款户外游戏而不是电子游戏🎮，这可能是有史以来运行时间最长的地理定位手机游戏之一。

**🔴 🏙️** [**入口**](https://www.ingress.com/)

在《口袋妖怪 Go》大获成功之前👎，Niantic 创造了具有未来主义主题的**入口**🚀如此多的功能:位置捕捉，建筑，PvP 动作，等等。

**🔴 📈** [**楼主**](https://landlordgame.com/)

房东允许玩家购买场地🏯他们参观并赚取租金💵当人们入住时📍在这些位置上。

**🔴** [**帮派报复**](https://mobile-italia.com/works/rog/)

在这个游戏中，玩家创建帮派👨‍👦‍👦为了领土而互相争斗🗺️ .游戏的目的是试图征服尽可能多的网格地图上的细胞。

## ⚙️定位为服务

**🔴 🏖** [**谷歌座位 API**](https://developers.google.com/places)

> 这项服务将在下面讨论👇在标记部分。

**🔴 🔪**[**motive . io**](https://www.motive.io/)**🌟**

> 与 Vuforia AR 集成的 Unity 位置后端。

该服务为基于位置的游戏提供了相当**完整的后端解决方案👍开发与地方匹配，用户位置跟踪，叙事设计和任务管理。**

他们还促进了 AR 与 Vuforia 的集成，但我相信，有了 ARKit 和 ARCore insight，现代 AR 方法的实施是时候了。

> 可悲的是， **Motive.io 目前仍处于封闭测试阶段。**

**🔴Backendless.com******🌟****

 **这项服务的地理定位功能似乎涵盖了大部分👍你需要的后端功能。然而，没有🚫back endless SDK for game engines right*(虽然大约一年前，据说还在开发中)*。

**🔴 🗺️** [**地图框**](https://www.mapbox.com/)

🌟Mapbox 是地理相关工具的工具箱。它甚至有移动 SDK 和 Unity SDK 来显示地图。Mapbox 分析工具 Turf.js 支持复杂的地理计算和估计。

# 🤖技术模式

## 🏁基于网格区域的方法

**格子图**在游戏里真的很流行。一个网格*将地图分割成多个连续的区域，称为* ***单元格*** *，具有相同的形状*(大多数情况下是正方形或六边形)。

🌟通过使用地理定位中的**网格方法**，游戏可以找出*玩家当前所在的细胞，并据此影响玩家的进程。*

考虑到世界地图🗺️作为一个**二维平面**，`latitude`和`longitude`是坐标，这个问题类似于*检查一个点是否在多边形内。* ☝️然而，存在区域**与地图环绕的**重叠的情况，*但是*这些情况可以用相对简单的算法来解决。

## 📌基于标记距离的方法

🌟在这种方法中，给定一个位置数据库，游戏需要找出这些位置中哪些是在玩家当前位置周围某个半径内的**，哪些是离玩家当前位置最近**的**。**

**🔴** **🏖️**[**Google places API**](https://developers.google.com/places)**-第三方方式**

🌟使用这种方法，数据库不保存位置，而是保存 Google Places API 上可用地点的 **ID。**

🌟Google Places 有一个非常好的🛢️ **位置数据库**的**现实生活中的位置。**[附近搜索请求 API](https://developers.google.com/places/web-service/search#PlaceSearchRequests) 🔎允许**搜索**在**半径**内玩家当前位置附近的**👉这是我们正在研究的问题。**

## - **注意 1:** 有可能*到*添加 Google Places 上不存在的地点。**不过，** [**那个 API**](https://developers.google.com/places/web-service/add-place) **从 2017 年 6 月开始就已经弃用了** ⛔ **。**因此，如果我们使用 Google Places API，我们的标记将**仅限于 Google Places** 上的内容。从好的方面来看🔅，它的数据库真的很大，所以这可能不是一个大问题。

**注意 2**IOs 版 Google Places API 强制执行默认的⚠️ **限制，即每 24 小时**内 1000 个请求。但是，可以通过简单的审核过程请求增加费用。

用这种方法，**数据库**的结构和操作将会**简单得多**，精致到谷歌服务的最显著特征。游戏后端只需要**将地点映射到期望的行为**。

**🔴** **⚗️球面距离公式——第一方方式**

这里有三个公式，包括: ***哈弗辛*** *公式*，*球面* ***余弦定律*** 和*等角矩形* 近似。这些都列在谷歌地图引用的文档中🗺️队。

👉根据该文件:

*   *球形* ***余弦定律-*** 提供了👍**小距离的最佳精度***和👎**整体表现最差**。*
**   ***哈弗辛*** *配方* **-** 过去最流行的**⏳因为它避免了在计算机🖥️不存在或非常原始的时代计算中的大的舍入误差。*****   ***等角*** *近似* **-** **有了👍* *最佳性能**同时提供👎**最差精度**。***

 ***🌟以目前的技术，*球面* ***余弦定律*** 变成了**广泛用于球面距离计算。谷歌地图🗺️的文档中，*关于此事*，也给出了基于****球面*** *余弦定律的[**SQL 查询**](https://developers.google.com/maps/solutions/store-locator/clothing-store-locator#finding-locations-with-mysql) 的例子。*👍***

 ***🔴** **🔬优化**

*无论选择哪一个公式*，这些技术的问题是公式需要大量的三角运算**，这些运算非常耗费 CPU 资源**🤖。在使用公式之前，✂️ **将记录**缩减到一个小的子集是很重要的。

🌟**修剪过程的方法**将使用**一个玩家位置在中心**的正方形，并且只有**在数据库中选择位于该正方形**内**的位置**。如网格部分所述，计算👆，比较简单。

* * *

## 🚚分配

有两种方式**分配奖金**💰现实生活中的地点📍玩家可以访问:

*   **手动✋:**通过手动创建位置，我们可以**建立合作关系**🤝通过投放**特殊奖金**💰在合作伙伴的位置📍。
*   **🤖** **自动** ** : **即使有了合作关系，我们仍然需要**填充**🌧️的地图上有许多固定的奖励地点，以保持玩家对游戏的兴趣。**

### 📁一般分配

🌟播种用🌱一开始，我们会在**著名景点**周围发放奖金🏯在选择性*(或全部)*城市🏙️全球*(或选定国家)*。

🌟使用 Google Places API 中的 [**文本搜索请求**](https://developers.google.com/places/web-service/search#TextSearchRequests) ，我们可以通过查询来搜索**名胜**景点*(旅游景点)*:

```
${cityName}+point+of+interest

    # Example requesting famous places in New York City
    https://maps.googleapis.com/maps/api/place/textsearch/json?query=new+york+city+point+of+interest 
```

响应返回 20 个位置对象和一个可用于获取更多位置的`next_page_token`字符串。

## 📌标记分布

标记分配相当简单:对于每个名人，我们只需要直接分配**奖金**💰到它的**位置**📍。

## 🏁网格分布

> **注:**我只覆盖**方格子只覆盖**。六边形网格更复杂，除了游戏视觉要求之外，方形网格实际上没有额外的好处。
> 
> **注意:**这里我使用了术语**子网格**，意思是网格中形成正方形的一组单元。

首先，我们决定一个正方形网格单元`S x S`的**大小** `S`，并把这个网格放在世界地图上🗺️.有两种选择:

*   网格覆盖了整个地图🗺️
    *   对于每个城市，我们找到完全覆盖该城市的最小子网格。
*   每个城市的自定义网格🏙️
    *   对于每个城市，找出**一个正方形，其大小是**的倍数`S`
    *   将正方形分成由`S x S`个单元格组成的网格。

为每个城市建立网格后，分配**奖金**💰去那间**包含著名景点**的牢房🏯。******