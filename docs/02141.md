# 用角和帆认证

> 原文:[https://dev . to/prestonjlamb/authentic ation-with-angular-and-sails-gk0](https://dev.to/prestonjlamb/authentication-with-angular-and-sails-gk0)

我最近不得不将一个应用程序从使用基于会话的身份验证(由服务器上的 passport 和 Sails.js 管理)转换为 JWT 身份验证。这是实现这一目标的步骤的快速分解。

## [](#angular)棱角分明

让我们从应用程序的角度开始。所以对于身份验证，我们需要我们的 Angular 应用程序从身份验证服务器获取一个令牌，存储它，并将其附加到每个传出的 HTTP 调用。在这种情况下，我们使用 Open ID Connect 身份验证服务器，但是相同的原则也适用于其他身份验证服务器和协议。我们还想使用安全措施来保护用户应该被认证才能使用的路由。

### [](#authenticating-with-the-auth-server)向认证服务器认证

为了验证 Angular 应用程序，我们使用了`angular-auth-oidc-client`包。安装说明非常清楚，遵循这些说明，您应该能够进行身份验证。为了简洁起见，我不打算在这里重复这些指令。然而，我要注意一件事，那就是包的配置应该在你的 Angular 应用程序的根目录`AppModule`中完成。我试图在一个单独的模块中完成它，甚至是一个导入到根模块中的模块，但无法让它工作。因此，我将坚持在根模块中这样做，如配置所示。

### [](#angular-http-interceptors)有角度的 HTTP 拦截器

在认证并取回令牌后，下一步是将该令牌附加到每个传出的 HTTP 调用。再说一次，这已经在很多很多的博客文章中提到过了。我将参考保罗·哈利迪的《T4》。我不会仔细检查每一件事情来完成它，但是基本上你应该使用`@angular/common/http`中新的`HttpClient`来进行所有的 HTTP 调用。然后，您可以`intercept`每个调用，并在这个过程中附加令牌作为授权头。写一次代码，应用到所有呼出的电话。简单明了。

### [](#angular-route-guards)棱角分明的路线卫士

最后，在前端，确保为所有需要身份验证的路由添加路由保护。在 guard 中，您可以使用您决定使用的安全服务来检查用户是否经过身份验证。如果是，让他们继续。如果没有，停止路由，并将它们发送到登录页面。如果你需要一些帮助来写你自己的，看看这篇关于路线守卫的文章。

## [T1】sails . js](#sailsjs)

这些信息专门讨论了如何使用 Sails.js 框架进行身份验证，但是 Sails 是在 Express 之上编写的，因此相同的步骤可以在 Express 应用程序中使用，并且可能可以在任何数量的应用程序中使用。当来自服务器的调用进入时，我们希望确保调用具有有效的授权头和令牌。我们需要验证和解码这个令牌，然后继续前进。如果它们未被认证，则返回禁止状态码；如果通过了身份验证，则继续工作流。

### [](#sailsjs-policies)Sails.js 政策

Sails.js 有一个很好的特性，叫做 policies。基本上，它们允许您在路线的控制器功能之前运行代码。这使得我们很容易确保每个调用都是经过认证的。在`config/policies.js`文件中，添加以下内容:`'*': 'yourPolicyName'`。在这种情况下，策略应该被命名为表示身份验证的名称。现在，每个调用都将通过这个策略，代码将运行。您可以更加具体，或者根据使用情形，根据需要排除路由通过此策略。

在策略中，我们应该检查`request`中的授权头和令牌。如果没有找到，返回禁止状态代码。接下来，使用一个包来验证令牌。在我们的例子中，我们使用了 Auth0 中的`jsonwebtoken`包。有一个`verify`函数，它将来自前端的令牌作为第一个参数，将来自 auth 服务器的秘密或公共密钥作为第二个参数。第三个参数是带有两个参数的回调函数。第一个是错误(如果一切正常，则为 null)，第二个是解码的用户(如果没有错误)。这里唯一的阻碍是获取正确格式的公钥，以确保我们可以验证令牌。

为了克服这个问题，我们又安装了一个包`openssl-cert-tools`。它允许您为 auth 服务器输入主机名和端口。然后，通过回调，它返回 PEM 编码的证书。该证书可用于`verify`功能。在用回调函数调用了`verify(token, certificate)`之后，您应该得到了解码后的用户。如果没有，再次返回禁止状态代码。如果一切顺利，继续前进。如果需要，您还可以保存解码后的用户供以后使用。

## [](#conclusion)结论

让身份验证工作起来需要一点时间，但总体来说很简单。认证令牌从认证服务器返回，从 Angular 应用程序传递到应用服务器，应用服务器验证它，然后一切继续。希望这有所帮助。如果您有任何问题，请联系我们(使用下面的链接)!