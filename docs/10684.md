# 仅使用密码的 UNIX 环境中的自动化

> 原文：<https://dev.to/ferricoxide/automation-in-a-password-only-unix-environment-2h6g>

有时，我的组织需要对大量的 Linux 系统运行特定的查询。通常，对于 HPSA、卫星等企业配置管理工具来说，这是一个很好的用例。不幸的是，我咨询的组织处于两种解决方案之间(他们的遗留工具烧毁了，他们的替代品还没有达到工作状态)。结果是，一个人需要做更多的事情。

我访问系统的首选方法是使用某种基于令牌的认证框架。当主机被 AD 集成时，您通常可以使用 Kerberos 来实现这一点。如果失败，您可以使用基于密钥的登录(如果您的所有目标都将您的密钥作为授权密钥)。虽然我的客户的系统*集成了* AD，但是他们的安全控制排除了使用 AD/Kerberos 的单点登录功能和使用基于 SSH 密钥的登录(老实说，在我需要查询的数百个目标中，几乎没有一个将我的密钥配置为授权密钥)。

因为(隧道)基于密码的登录是强制的，我最初考虑的是必须编写一个 expect 脚本来避免输入几百次密码。幸运的是，在工具“sshpass”中有一个替代方法。

SSH pass 允许您通过多种方法提供密码:命令行参数、包含密码的文件、环境变量值甚至从 STDIN 读取。我不喜欢包含密码的文本文件(它们很容易被忘记并留在系统中——不吉利)。我也不太喜欢命令行参数——尤其是在多用户系统中，如果其他人在错误的时间`ps`可能会看到您的密码(这种可能性随着您的作业运行时间的增加而增加)。STDIN 方法比命令 arg 方法稍微好一点(出于类似的原因)。至少对于环境变量来说，这个值实际上只存在于内存中(特别是如果您已经将 HISTFILE 位置设置为某个非持久的位置)。

我所做的特别审计是试图确定数百台虚拟机的来源。随着时间的推移，组织已经使用了由几个小组创作的模板——以及其中一个小组中的不同人员。我需要扫描所有的系统，看看他们可能使用了哪个模板，因为模板信息已经从托管环境中删除了。因此，我需要运行一个 SSH 封装的命令来找到每个模板的特征。最终，我做的是:

1.  将我的查询帐户的密码放入 sshpass 使用的环境变量“SSHPASS”
2.  生成了一个包含所有相关虚拟机 IP 的文件。
3.  设置一个 for 循环来迭代列表
4.  循环`sshpass -e ssh -o PubkeyAuthentication=no StrictHostKeyChecking=no <USER>@${HOST} <AUDIT_COMMAND_SEQUENCE> 2>&1`
5.  通过一个有序的过滤器阻塞 STDOUT，去掉我不感兴趣的垃圾，并将适合 CSV 的分隔符放入每个查询主机的字符串中。
6.  将批次捕获到文本文件中

需要使用`PubkeyAuthentication=no`选项，因为我几乎总是启用 SSH-agent(或代理转发)。这会导致我的密钥被传递。根据目标的安全设置，这将导致连接中止，除非我显式地禁止传递我的代理密钥。

需要使用`StrictHostKeyChecking=no`选项，因为我以前从未登录过这些主机。我们的标准 SSH 客户端配置是在接受远程密钥(并将其放入`${HOME}/.ssh/known_hosts`)之前要求确认。如果没有这个选项，我需要确认是否接受每个键...这就像要重复输入数百次密码一样破坏了自动化。

一旦完成以上工作，我就有了一个可以读入 Excel 的漂亮的 CSV 文件和一个电子表格，交给询问“谁构建/拥有这些系统”的人。

这种方法还意味着，对于拒绝审核凭据的主机，很容易进行报告”...而且这一批没有正确配置为与 AD 一起工作”。