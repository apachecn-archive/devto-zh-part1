# 使用 dep 管理 Go 依赖项

> 原文:[https://dev.to/ykyuen/manage-go-dependencies-using-dep-16p9](https://dev.to/ykyuen/manage-go-dependencies-using-dep-16p9)

## T2】

**更新@ 2018-11-26:科技不仅仅是在以极快的速度前进，也在快速变化。不出一年，这篇文章就过时了！**

> ![John Arundel profile image](../Images/d5b2c679b32132ce7a1fcdb5864c2ee1.png)约翰阿伦德尔[@比特菲尔德](https://dev.to/bitfield)![twitter logo](../Images/4c8a2313941dda016bf4d78d103264aa.png)[@雅库特](https://twitter.com/yakuter) [@ykyuen](https://twitter.com/ykyuen) 这个已经严重过时了！Go 从 1.11 开始就有了内置的依赖管理，dep 不再是一个东西。2018 年 11 月 24 日 23 点 26 分[![Twitter reply action](../Images/44d8b042100e231770330321e5b63d65.png)](https://twitter.com/intent/tweet?in_reply_to=1066473266020261888)[![Twitter retweet action](../Images/93d9c70ccc54851d2e8e881b53c21dae.png)](https://twitter.com/intent/retweet?tweet_id=1066473266020261888)[![Twitter like action](../Images/2e93f7775eadefab8bcd34a4542cc5a7.png)](https://twitter.com/intent/like?tweet_id=1066473266020261888)

并根据 [dep 项目页面](https://github.com/golang/dep):

> dep 是“官方实验”。从 1.11 开始，Go 工具链已经(实验性地)采用了一种与 dep 截然不同的方法。因此，我们在继续开发 dep，但是 gear 的工作主要是为工具链中的版本控制行为开发一个替代原型。

关于新 Go 内置管理的更多信息，请参考官方 GitHub Wiki - [Go 1.11 模块](https://github.com/golang/go/wiki/Modules)。

感谢[约翰·阿伦德尔@比特菲尔德](https://twitter.com/bitfield)和[二汗·雅库特@雅库特](https://twitter.com/yakuter)揭露问题。🙇🏽‍♂️

* * *

**更新@ 2018-02-03: [来自 godep 团队的 Sam Boyer](https://github.com/sdboyer) 澄清了本文中一些不正确的信息。对于由此带来的不便，我向山姆·博耶和读者道歉。**😢

* * *

*最初发布在[水手长博客](https://blog.boatswain.io/post/manage-go-dependencies-using-dep/)上。*

* * *

之前我在使用 [Glide](https://glide.sh/) 的 [Go](https://golang.org/) 中发布了一篇关于依赖管理的[文章，我得到了关于](https://blog.boatswain.io/post/manage-go-dependencies-using-glide/) [Glide](https://glide.sh/) 将会过时的反馈，并且 [Glide](https://glide.sh/) 团队建议用户转移到由 [golang](https://golang.org/) 团队编写的另一个名为 [dep](https://github.com/golang/dep) 的依赖管理工具。

> Go 社区现在有了 dep 项目来管理依赖关系。请考虑尝试从 Glide 迁移到 dep...Glide 将在一段时间内继续得到支持，但被视为处于支持状态，而不是积极的功能开发。

在 [Go 1.10 版本](https://tip.golang.org/doc/go1.10)中有一个关于将 [dep](https://github.com/golang/dep) 整合到工具链中的计划，但似乎[还有一段路要走](https://www.reddit.com/r/golang/comments/7dd2ty/go_110_release_notes_draft/#thing_t1_dpwyj4i)。

**更新@ 2018-02-03:**

*   **[dep](https://github.com/golang/dep) 正式发布。**
*   **[dep](https://github.com/golang/dep) 没有进入 1.10 的工具链。请参考[路线图](https://github.com/golang/dep/wiki/Roadmap)了解最新信息。**

[![Technology is moving too fast](../Images/cb8980f56909c49f1b3e027e470f0343.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--8z24Fa5r--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/kghqq76vmqrkz019hkob.jpg)

##### 而我就是不够快。🐌

## [](#create-the-project-inside-gopath)在 GOPATH 中创建项目

和以前一样，让我们创建一个新项目，根路径为*$ GOPATH/src/git lab . com/yk yuen/dep-example*，并添加以下文件。

`main.go`

```
package main

import humanize "github.com/dustin/go-humanize"
import "fmt"

func main() {
  fmt.Println("hello world")
  fmt.Printf("That file is %s.\n", humanize.Bytes(82854982)) // That file is 83 MB.
  fmt.Printf("You're my %s best friend.\n", humanize.Ordinal(193)) // You are my 193rd best friend.
  fmt.Printf("You owe $%s.\n", humanize.Comma(6582491)) // You owe $6,582,491.
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## dep 方式

### [](#gopkgtoml-and-gopkglock)Gopkg.toml 和 Gopkg.lock

[dep](https://github.com/golang/dep) 读取两个名为 *Gopkg.toml* 和 *Gopkg.lock* 的文件。让我们初始化这两个文件。

```
[ykyuen@camus dep-example]$ dep init
  Using master as constraint for direct dep github.com/dustin/go-humanize
  Locking in master (bb3d318) for direct dep github.com/dustin/go-humanize 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

如您所见， *dep init* 命令扫描源代码，并将项目所需的所有包下载到*供应商*文件夹中。

*Gopkg.lock* 和 *glide.lock* 文件的作用完全一样，锁定**包的版本，除了**版本应该在 *Gopkg.toml* 中维护。简而言之， *Gopkg.lock* 文件是自动生成的，它依赖于源代码中的 *import* 语句，其版本由 *Gopkg.toml* 控制。

[![](../Images/cae4b499893086a06cd2ca92aa7caf46.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--u8bc5kMj--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/76aglpqie9q1kx22ft78.png)

### [](#update-dependencys-version)更新依赖关系的版本

让我们编辑一下 *Gopkg.toml* ，用稍微老一点版本的 [go-humanize](https://github.com/dustin/go-humanize) 包代替最新的 master branch。

```
# Gopkg.toml example
#
# Refer to https://github.com/golang/dep/blob/master/docs/Gopkg.toml.md
# for detailed Gopkg.toml documentation.
#
# required = ["github.com/user/thing/cmd/thing"]
# ignored = ["github.com/user/project/pkgX", "bitbucket.org/user/project/pkgA/pkgY"]
#
# [[constraint]]
#   name = "github.com/user/project"
#   version = "1.0.0"
#
# [[constraint]]
#   name = "github.com/user/project2"
#   branch = "dev"
#   source = "github.com/myfork/project2"
#
# [[override]]
#  name = "github.com/x/y"
#  version = "2.4.0"

[[constraint]]
  #branch = "master"
  name = "github.com/dustin/go-humanize"
  revision = "0b19b17f90333e44518aa31bbf8126017960aee3" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

然后运行 *dep 确保*将包更新到所需版本。以下是更新后的 *Gopkg.lock* 的区别。

```
-------- /home/ykyuen/go/src/gitlab.com/ykyuen/dep-example/Gopkg.lock +++ # This file is autogenerated, do not edit; changes @@ -2,14 +2,13 @@

 [[projects]]
-  branch = "master"
   name = "github.com/dustin/go-humanize"
   packages = ["."]
-  revision = "bb3d318650d48840a39aa21a027c6630e198e626" +  revision = "0b19b17f90333e44518aa31bbf8126017960aee3" 
 [solve-meta]
   analyzer-name = "dep"
   analyzer-version = 1
-  inputs-digest = "a5d65a2bdf47e41b99ad71813142ae93970f5806c77630b2aea665fe631dde23" +  inputs-digest = "0023bfe634a061b89ae0fbd71e3236f3f75f0843a0c974eeb9822040c0ea2dc4"
   solver-name = "gps-cdcl"
   solver-version = 1 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#add-a-new-dependency)添加新的依赖关系

可以使用*dep assure-add*命令添加新的包。

```
[ykyuen@camus dep-example]$ dep ensure -add github.com/leekchan/accounting
Fetching sources...

"github.com/leekchan/accounting" is not imported by your project, and has been temporarily added to Gopkg.lock and vendor/.
If you run "dep ensure" again before actually importing it, it will disappear from Gopkg.lock and vendor/. 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

现在我们已经在*供应商*文件夹中准备好了新的*会计*包，新的约束被写入 *Gopkg.toml* 并被锁定在 *Gopkg.lock* 中。让我们更新 *main.go* 如下。

`main.go`

```
package main

import humanize "github.com/dustin/go-humanize"
import accounting "github.com/leekchan/accounting"
import "math/big"
import "fmt"

func main() {
  fmt.Println("hello world")
  fmt.Printf("That file is %s.\n", humanize.Bytes(82854982)) // That file is 83 MB.
  fmt.Printf("You're my %s best friend.\n", humanize.Ordinal(193)) // You are my 193rd best friend.
  fmt.Printf("You owe $%s.\n", humanize.Comma(6582491)) // You owe $6,582,491.

  ac := accounting.Accounting{Symbol: "$", Precision: 2}
  fmt.Println(ac.FormatMoney(123456789.213123))                       // "$123,456,789.21"
  fmt.Println(ac.FormatMoney(12345678))                               // "$12,345,678.00"
  fmt.Println(ac.FormatMoney(big.NewRat(77777777, 3)))                // "$25,925,925.67"
  fmt.Println(ac.FormatMoney(big.NewRat(-77777777, 3)))               // "-$25,925,925.67"
  fmt.Println(ac.FormatMoneyBigFloat(big.NewFloat(123456789.213123))) // "$123,456,789.21"
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

并运行它。

```
[ykyuen@camus dep-example]$ go run main.go
hello world
That file is 83 MB.
You're my 193rd best friend.
You owe $6,582,491.
$123,456,789.21
$12,345,678.00
$25,925,925.67
-$25,925,925.67
$123,456,789.21 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#the-issue-with-git-submodule)与 git 子模块的问题

与 [Glide](https://glide.sh/) 相比， [dep](https://github.com/golang/dep) 的一个主要区别是软件包的子模块被忽略。比如 [dep](https://github.com/golang/dep) 添加 [go-goracle/goracle](https://github.com/go-goracle/goracle) 包后，里面的 [odpi](https://oracle.github.io/odpi/) 子模块为空导致错误。删除子模块的原因可以在下面的链接中找到。

*   有计划添加 git 子模块支持吗？

**更新@ 2018-02-03:**

**关于 git 子模块的段落不正确。**

**[山姆·博耶](https://github.com/sdboyer)写道:**

> 在您描述的情况下，dep 应该可以很好地引入 git 子模块。我只是在本地复制了你在这里描述的东西，问题不在于子模块——而是在 github.com/go-goracle/goracle/odpi,没有 Go 代码，所以不能直接导入。
> 
> 您可能需要专门为该项目关闭 Gopkg.toml 中未使用的包修剪，否则 dep ensure 将自动直接删除看起来是未使用的包(但看起来它实际上是由 cgo 使用的)。

**更新@ 2018-03-04:**

发现 [go-goracle/goracle](https://github.com/go-goracle/goracle) 包与 [dep](https://github.com/golang/dep) 不兼容。你可以关注下面的问题，查看来自 [dep](https://github.com/golang/dep) 团队的最新更新。

*   [在 dep 确保命令](https://github.com/golang/dep/issues/1633)之后，无法获取包的 git 子模块

## [](#summary)总结

*   ~~[dep](https://github.com/golang/dep) 很有可能成为 [Golang](https://golang.org/) 社区的官方依赖管理工具。~~
*   如果你正在开始一个新的 [Golang](https://golang.org/) 项目，那么 [dep](https://github.com/golang/dep) 是个不错的选择。
*   如果你在一个遗留项目中使用 [Glide](https://glide.sh/) 。你可以考虑迁移到 [dep](https://github.com/golang/dep) 但是我认为继续使用 [Glide](https://glide.sh/) 一段时间直到 [dep](https://github.com/golang/dep) 正式发布也没有坏处。
*   此外，缺少软件包的子模块可能会导致您的代码出现故障。
*   **[dep](https://github.com/golang/dep) 正式发布。**
*   **[dep](https://github.com/golang/dep) 在拉 git 子模块上工作良好。**
*   你可以在[gitlab.com](https://gitlab.com/ykyuen/dep-example)上查看这个例子。