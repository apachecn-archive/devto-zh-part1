# 测试还是监控？MTBF 还是 MTTR？做出你的选择！

> 原文:[https://dev . to/danlebrero/testing-or-monitoring-mtbf-or-MTTR-make-your-choice](https://dev.to/danlebrero/testing-or-monitoring-mtbf-or-mttr-make-your-choice)

*本文原载于[我的博客](http://danlebrero.com/2017/06/05/testing-or-monitoring-mtbf-mttr-make-your-choice/)T3】*

让我们想象一个虚构的世界，在这个世界里，邪恶和无能的管理者是常态。在这样一个远离我们现实的世界里，经理们吞噬新闻聚合网站，因为他们只有时间阅读新闻标题，而不是内容。

最近一篇流行文章的标题“测试和监控:同一个硬币的两面”清楚地表明(至少对你的经理来说)，开发人员再次在多余的技术活动中浪费 BigCorp 的钱。因此，在您的下一次项目启动会议上，他挑选了一张卡片，写下了以下故事:

> **作为一名**经理
> **我希望**有监控或自动化测试，但不能两者兼而有之
> **这样**我们就能节省一大笔钱”

随着经理狂笑的回声逐渐消失，你安慰自己说，至少他填写了“所以”部分。

你的团队被这个选择撕裂了。

一半的队友投票支持全自动测试套件，另一半支持在生产中有良好的监控。

你有决定性的一票。你的选择是什么？

给自己一分钟来决定。

## 测试套件

如果您选择一个测试套件，您的目标是在产品中没有任何错误。

您将通过单元测试和验收测试来了解您正在构建正确的东西，通过集成测试和系统测试来检查组件是否可以相互通信，通过性能测试和浸泡测试来了解您是否有足够的能力，并通过[弹性测试](http://danlebrero.com/2017/05/20/automating-resilience-testing-with-docker-and-property-based-testing-devoxx-uk-2017-video/#content)来确保您的系统能够应对故障。

你会在发展过程中充满自信。

但是，当您部署到生产环境时，又会怎样呢？你忘了一些测试用例吗？测试数据有代表性吗？什么是延迟？你误解了生意吗？[社会安全号码不唯一](http://www.computerworld.com/article/2552992/it-management/not-so-unique.html)？？你测试了 IE6 中的登录表单了吗？亚马逊 S3 消失了吗？？？？我们的网站在 HackerNews...！

要测试的排列太多，要考虑的可能性太多，要做的假设太多，未知的未知太多。

充满恐惧的黑暗房间。

## 监控

如果您选择监控，您会试图尽快发现生产中的任何问题。您的警报和仪表板会让您知道。

但是如果没有测试安全网，你知道错误和问题会更频繁地发生。部署到生产环境将会很可怕，但至少您将会了解它的状态。

通过测试，我们希望我们没有将任何错误部署到产品中，通过监控，我们知道我们是否部署了。

此外，为了降低风险，不进行测试会鼓励你遵循一些连续的交付实践:[小变化](https://continuousdelivery.com/principles/#work-in-small-batches)、[特性切换](https://martinfowler.com/articles/feature-toggles.html)和[金丝雀发布](https://martinfowler.com/bliki/CanaryRelease.html)。

基本上，你会让你的客户以一种安全可控的方式进行测试。您的“测试将使用生产数据、生产服务器和生产流量运行。不做任何假设，不涉及任何置换。

最后，一旦你有了这个能力，它将允许你做一些自动化测试套件永远不会给你的事情:通过 A/B 测试来测试商业想法。

所以监控会给你窥视一个房间的能力，如果里面充满了恐怖，就把门关上。

## 回到现实世界

值得庆幸的是，我们并不是生活在这样一个无理由要求的世界里，所以我们不需要做出艰难的选择。

在现实世界中，我们将同时进行测试和监控，但是由于我们没有无限的时间，我们需要对我们的工作进行优先级排序。

如果我们对测试进行优先排序，我们会试图增加我们的 MTBF(平均故障间隔时间),而对监控进行优先排序会减少我们的 MTTR(平均修复时间)。

Chad Fowler 和 John Allspaw 都认为对于大多数业务和故障类型来说，优化 MTTR 比优化 MTBF 更好，但是平衡点在哪里呢？

如果我们看看可用性公式:

*可用性=正常运行时间/(正常运行时间+停机时间)*

可以翻译成:

*可用性= MTBF / (MTBF + MTTR)*

这允许我们计算给定可用性目标的 MTBF 或 MTTR:

*MTBF =可用性* MTTR / (1 -可用性)*

*MTTR =平均无故障时间/可用性-平均无故障时间*

如果您知道**检测**并修复一个问题通常需要多长时间，也就是说，您知道您的 MTTR，那么您可以在下表中看到对于您期望的 SLA，生产问题发生的频率(数字四舍五入):

| 可用性/ MTTR | 1h | 4h | 24 小时 |
| --- | --- | --- | --- |
| 90 % | 9h | 1 天 12 小时 | 9d |
| 95 % | 19h | 3d 4h | 19d |
| 99 % | 4d 3h | 2w | 350 万 |
| 99.9 % | 6w | 6mo | 2.8 岁 |
| 99.99 % | 1y 10d | 4.5 岁 | 28y |
| 99.999 % | 11.5 岁 | 45y | 280y |

因此，如果您的 MTTR 是一个小时，那么系统可以每九个小时中断一次，仍然可以实现 90%的可用性，但是如果您的目标是 99.99%的可用性，那么您一年不能有一个以上的问题！

类似地，如果您知道您通常将 bug 部署到产品中的频率或者事情变坏的频率，您就可以计算您的目标可用性的 MTTR:

| 可用性/平均无故障时间 | 7d | 1mo | 3mo | 6mo |
| --- | --- | --- | --- | --- |
| 90 % | 19h | 三维（three dimension 的缩写） | 1w 2d | 2w 6d |
| 95 % | 9h | 1 天 12 小时 | 4d 10h | 1w 2d |
| 99 % | 1.5 小时 | 7h | 20h | 1 天 20 小时 |
| 99.9 % | 10m | 40 米 | 2h | 4.5 小时 |
| 99.99 % | 1m | 4m | 12 米 | 26 米 |
| 99.999 % | 7s | 24s | 1m | 2m |

因此，如果您每月有一个问题，您需要能够在不到 40 分钟的时间内检测并修复它，以实现 99.9%的可用性。

从上面的两个表中，您可以看到，为了实现高可用性，非常低的 MTTR 是强制性的。

此外，低 MTTR 不需要人工干预，因此没有时间来修复和部署错误修复或跳转到框中重新启动。自动检测是关键，因此监控也是关键。

请注意，金丝雀释放会给你更多的时间来检测问题。如果您只发送 1%的流量，那么您的检测时间会增加大约 x100 倍。当然，这是假设 1%的流量代表了整体流量，并且能够引起问题。

即使您从未部署任何错误，您的生产环境也会发生变化，因为您的服务器需要更新，您的网络电缆会被损坏，人类会犯错误，并且您的用户行为会随着时间的推移而改变。

墨菲定律将确保你的系统会失败。因为失败是不可避免的，你需要学会应对它。

## 结论

希望在这一点上，您同意监控和自动化测试套件一样重要。

但是如果你回顾你最近的项目，相对于你在测试上花费的时间，你花费了多少时间和精力来思考、构建和编码你的监控？

与其重要性成正比吗？

监控不应该是在我们将产品部署到生产环境之前的事后想法。

监控应该是你对完成的定义的一部分，是你开发过程的核心部分。

当然，不要忘记为您的监控准备一个非常好的测试工具！

如果你对这篇文章感兴趣，有一个更好的方法来计算可用性。参见[错误预算:谷歌可持续创新的解决方案](http://danlebrero.com/2017/07/16/error-budget-google-solution-for-innovating-at-a-sustainable-pace/)。