# 如何在生产中调试

> 原文:[https://dev.to/tamasrev/how-to-debug-in-production-4f8](https://dev.to/tamasrev/how-to-debug-in-production-4f8)

我们都见过生产中的错误。有时候我们可以复制它们，有时候不行。

当我们能复制它们时，我们就能快速修复它。然后我们做一些回归测试，看看我们是否破坏了其他东西。然后我们就完事了。

当我们不能复制它时，那是一个完全不同的故事。

### 我们怎么知道自己无法重现？

这听起来很简单，不是吗？我们尝试使用该系统，问题还没有出现。有没有可能我们只是还不能复制它？有没有可能我们离复制它只有一步之遥？

让我们从哲学问题转向实用问题。试图重现一个 NullPointerException 是浪费时间吗？盲目添加一些代码是不是更大的时间浪费？我们是怎么知道的？

通常我们有一个繁殖的过程。这个过程通常是隐性的，没有人写下来。我的过程看起来像这样:

1.  阅读错误报告
2.  快速检查异常跟踪，希望它揭示一个明显的问题
3.  试着根据错误报告上写的内容重现它
4.  分析日志和相关的源代码，找出可能发生的情况
5.  试着再复制一次
6.  在多线程编程的情况下，调整线程和锁来重现奇怪的情况

在每一步，我都可能回头阅读错误报告和日志。一两天后，我要么复制 bug，要么放弃搜索。

当我放弃的时候，我会做两件事中的一件或两件:

1.  通过单元测试重现并解决问题。
2.  添加更多日志记录。

如果我们用单元测试重现一个问题，那么我们很可能只修复一个症状。比方说，如果我们添加另一个空检查，那么我们仍然不知道为什么某个方法会收到无效数据。很快我们就会看到其他的。

当我们添加日志记录时，我们将使用大量资源，如 CPU、磁盘和内存。运营商大多数时候是不会允许的。他们通常认为修复这个 bug 是至关重要的。是的，他们想帮你找出根本原因。不，对不起，他们不能让你添加日志。

幸运的是，有几种方法可以有效地从生产中获取调试数据。

### 日志修复 1:采样

一种方法是抽样。我们不必记录每个用户会话。我们可以选择每第 1000 个用户会话，并记录他们的所有数据。或者，我们可以使用随机生成器来选择每 1000 个用户会话并记录下来。

这只有在 bug 频繁出现时才有用。请记住，我们需要对用户会话进行采样，而不是记录事件。所以我们会得到出错的详细信息。

您可以配置日志采样。因此，如果生产操作人员发现我们的日志记录在高峰时间仍然使用了太多的资源，他们可能会将其关闭几个小时。

测井取样的另一种方法是 A/B 测试。如果我们的架构允许，我们可能会在一小部分服务器上打开调试日志。

### 日志修复 2:在内存中记录会话

有时我们可以在内存中记录调试数据。如果在用户会话中出现错误，那么我们可以将其写入文件。如果没有，那么我们就简单地释放已经分配的内存。

如果错误不常发生，这很有用。在这种情况下，我们必须做些什么，以便在错误发生时就抓住它。但是，生产运营不一定会为此高兴。这取决于我们的调试日志的内存需求。

我们可以将这种日志记录与日志采样结合起来。例如，我们为每 10 个用户会话记录调试数据，并在出现错误时将其写入文件。

### 日志修复 3:内存环形缓冲区，由 [Kofa](https://www.linkedin.com/in/istv%C3%A1n-kov%C3%A1cs-5619031/) 提供。

István Kovács 解释了第三种方法:内存环形缓冲区。每个日志都进入这个内存中的环形缓冲区。该缓冲区具有可配置的大小。另外，它是一个环形缓冲区，所以最新的日志会覆盖最早的行。

通常放在文件中的日志，它们仍然放在文件中。当错误发生时，整个环形缓冲区被写入一个文件。

这很酷，因为内存开销是有限的。如果您正确设置了环形缓冲区的大小，那么您将拥有所需的所有调试数据。另一方面，您可能需要花费一些时间来为这个环形缓冲区找到合适的大小。

你的方法是什么？

* * *

最初出现在[塔马斯雷夫](https://tamasrev.wordpress.com)。