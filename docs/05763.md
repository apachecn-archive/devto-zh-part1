# 软件团队的消防演习

> 原文:[https://dev.to/dosomething/fire-drills-for-software-teams](https://dev.to/dosomething/fire-drills-for-software-teams)

*转载自[媒体](https://medium.com/@mshmsh5000/fire-drills-for-software-teams-164ba48b10b1)。*

在漫长的一天结束时，我在 Twitter 上偶然发现了 GitLab 正在上演的 IT 灾难。他们错误地删除了一个生产数据库，损失了数小时的问题、用户、评论等等。我立刻为他们的团队感到心痛:当你删除重要的生产数据，然后发现你的备份系统救不了你时，这是一种非常特殊的感觉。你脚下没有地板，没有倒转时间的按钮，只有一种强烈的恐怖感。

对丢失生产数据的反应往往遵循一种行为模式。首先是恢复尝试，通常会取得部分成功，因为团队会找到备用的事实备份(QA 服务器、不完整的数据集)。第二个阶段是稳定期，在这个阶段，团队会考虑万一真的有什么东西不见了怎么办。在那之后，事后分析(对任何人来说都必须是无可指责的，以便学习和前进)应该从事件中吸取教训，并从每个演员的角度填写一个更完整的故事。

参与事后分析的团队将提出补救工作，旨在防止此类故障再次发生。每个吃过苦头的人都会非常积极地去定义这项工作，并实现它。车队希望以一种全新的安全感来结束这段时期。

但是总有一个令人烦恼的问题，同样的担忧从安全领域悄悄溜走，落在工程师的肩上:我们错过了什么？下一次失败会发生在哪里？我们现在正在做或没有做的事情会在六个月后影响我们吗？

事后反思应该是具有启发性的事件，但根据定义，它们也是对特定失败的反应。很难找到事后分析的界限，所以你可以指着更远的地方问，“但是我们还没有想到的那件事怎么办呢？我们需要一种额外的实践，一种可以在受控环境中产生更多失败的实践——也就是说，更多学习的实践。

拥有分布式系统的大型工程组织可以实现像网飞的[混沌猴](https://github.com/netflix/chaosmonkey)这样的系统，这是一个半随机杀死你系统中其他服务器的应用程序。这迫使工程师设计弹性软件，这样当个别机器出现故障时，服务可以继续运行。在实践中，运行 Chaos Monkey 的好处随着部署和团队规模的增长而增加。拥有更简单、更少分布式系统的小型组织不会从 Monkey 方法中受益。

2016 年夏天，DoSomething 发生了一场我们自己的文件丢失灾难。总的总结太熟悉了，尤其是在阅读了 GitLab 事件之后:我们中的一个人在深夜重启了生产中的文件传输过程。该过程始于不正确的配置(小心使用任何具有“破坏性模式”的工具)，并在我们能够识别和阻止它之前费力地删除了数十万个文件。更糟糕的是，我们发现我们的核心备份过程已经悄悄地失败了一段时间。我们最终设法从旧备份和其他来源恢复了 94%的文件，但恢复工作的痛苦一直伴随着我们，更不用说不可恢复的 6%了。

事后，一位明智的首席技术官朋友，公共科学图书馆的 CJ Rayhill 建议我进行消防演习。她在高度管制行业的咨询经验向她展示了在全面毁灭的情况下管理 IT 团队的价值。他们会发现明显的变化，如改善数据备份的访问。他们还会发现更多不为人知的失败，比如当没有人知道如何改变公司的语音邮件来更新外发信息时。

消防演习的性质当然会因团队和行业而异。对我们来说，消防演习始于两个主要问题:丢失或损坏的数据集，以及丢失部署的系统(服务器和网络)。消防演习在其范围内包括通信、文档和其他人为因素，而混沌猴子式的故障工程将其范围限制在软件设计。

我们的基础设施团队设定了每个季度进行两到三次消防演习的目标。为了确定从哪里开始，我们选择了一个关键的、但是相当独立的系统。我们想首先关注第一次进行消防演习的机制和后勤工作。我们需要解决一些基本问题:它看起来像什么？谁参与了？谁是负责人？需要多长时间？你如何定义这场灾难？你如何记录发生的事情？结束后你会做什么？诸如此类。

我们的团队已经运行了足够多的这些来定义一些需求和实践:

## [](#write-a-treatment)写治疗

我们追求一定程度的逼真度，包括角色阵容和清晰的动作边界。所以我们从一种电影处理开始:

> 系统 X 在 New Relic 中注册为不可用。当我们查看 AWS 时，我们看到整个 VPC 都被破坏了:应用服务器、Redis 缓存和 MongoDB 集群都不见了。AWS 区域和可用性区域仍然可用。

这就是剧情概要。注意，它还定义了什么在范围内，什么不在范围内:在这种情况下，AWS 本身不在本练习的范围内。

对于一组角色，我们不仅要指定谁参与其中，还要指定他们应该扮演什么角色。这是我们机构记忆的一部分。它还让我们在针对同一系统的后续演练中，尝试改变一些参数，或者扩大问题的范围。

## [](#create-a-raci-matrix)创建 RACI 矩阵

RACI 是一个有用的工具，可以确保项目中的团队成员在不冒犯彼此的情况下进行交流。RACI 定义了人们在一个项目中扮演的角色:负责任的，负责任的，被咨询的，知情的。

在像我们这样规模的组织(也就是说，60 名员工)的消防演习中，让一个人做出重大决策对我们来说是有意义的(这就是 *A* )。不止一个人可以做这项工作(T2 R T3)。其他人需要给出反馈并提供机构记忆，尤其是当我们试图用不完整的文档来重建一个系统的时候(T4 Cs T5)。还有一些人只需要知道演习什么时候开始，进行得怎么样，什么时候结束(*就是*)。

实际上，这可能很简单:在文档的顶部有四个 *R、A、C、I* 项目符号。但是决定谁参与，以及如何参与，对于在混乱的情况下提供清晰性是至关重要的。紧急情况下最昂贵的问题之一是不知道谁需要做出关键的判断。

## [](#specify-acceptance-criteria)指定验收标准

我们怎么知道我们什么时候把系统恢复了？我们是将这个系统集成到一个更大的部署中来证明它正常工作，还是针对它运行一个测试套件？类似于敏捷团队的“完成”定义，这一步告诉团队什么是成功，这样他们就可以结束消防演习。

## [](#make-predictions)做出预测

我们用消防演习的技巧来打赌我们会如何反应。我们认为如何恢复系统？我们在担心什么？我们可以将这种分析与实际发生的情况进行比较，并从计划和现实之间的偏差中提取重要信息。

不是每个团队都可以采取这一步，因为他们可能希望测试包括团队如何分析情况并在最激烈的时刻创建解决方案。

Rayhill 强调了“演习的真实性……能够用真实的演员和真实的结果模拟真实的演习是挑战您的组织尽可能做好准备的唯一方法。”

## [](#set-a-time-limit)设定时限

假设一个系统宕机，备份不可用，换句话说，这是 2016 年 7 月发生的真实事件。消防演习应该持续多久？这个团队是二十四小时不停地碰壁，还是八小时后就退出？尤其重要的是，要为训练出错设定一个时间限制，这样就不会成为令人沮丧的练习。

在恢复完全失败的情况下，结束消防演习，解决致命问题，并重新安排演习。

## [](#keep-a-journal)记日记

在盛怒之下，我们可能会做出一系列失败的尝试，或者考虑一些我们很快就会放弃的方法。我们想把这些写下来，作为以后回顾的时间表。这是一系列的事件，我们可以稍后检查，以找到我们的决策、系统和文档中的漏洞。

> 重要的是记录到底发生了什么，然后在事后回顾中进行改进。*–CJ 雷希尔*

在 DoSomething，我们可能会像往常一样在 Slack 中协调回应，但我们通常会在一个共享的谷歌文档中保留回应笔记，以便每个人都可以贡献和审查。作为机构记忆，这些笔记是黄金:保存它们，让它们有条理。

## [](#run-a-postmortem)运行剖验

事件发生后，像分析真实事件一样进行分析。看看时间线和所有的工件，包括重建的系统。我们恢复运行了吗？有趣的差距在哪里？如果我们没有让系统通过我们的验收标准，在我们重新进行消防演习之前，最关键的部分是什么？

## [](#close-the-gaps)弥合差距

我们追求一个简单的规则:在开始另一个消防演习之前，我们必须解决一个消防演习发现的关键漏洞。这有助于防止我们在随后的两次消防演习中犯同样的错误。它也减轻了团队被积压工作淹没的风险。

其他团队可能会决定不实施这种补救措施和后续训练的序列化。Rayhill 承认“对某个问题的补救对组织来说可能是昂贵的。如果她的团队确定成本太高，他们仍然会“记录我们的推理，以便审计人员可以使用。"

## [](#emphasize-learning)强调学习

消防演习的主要原则是利用实验室环境创建尽可能多的故障信息。使用钻头来发现弱点，然后不断敲打这些弱点，直到它们变得更强。您的弱点可能在于沟通和决策、备份的新鲜度和可用性、警报和监控、文档、不必要的复杂性或自动化。

> 当我……在一个组织中开始这个过程时，我们第一次进行演练时甚至不能完成前三步！但是我们修复了出错的地方，并一直坚持下去，直到完成整个练习。–*CJ ray hill*

最有可能的是，进行消防演习的团队会发现许多类别的故障。这些发现中的每一个都应该引起庆祝，因为在实验室中发现问题的团队可以在它在野外咬它们之前修复它。

## [](#further-reading-amp-thanks)延伸阅读&感谢

谷歌通过名为[DiRT:Disaster Recovery Testing](https://queue.acm.org/detail.cfm?id=2371516)的实践大规模运行这些训练。

网飞式的混沌工程既有网上社区(T0)又有原理解释(T3)的(T2)。

OpsCode [的杰西·罗宾斯设立了游戏日活动](https://www.usenix.org/legacy/events/lisa11/tech/tech.html#Robbins)来模拟灾难。奥巴马 2012 团队在[十种令人担忧的味道](http://highscalability.com/blog/2016/8/9/10-gameday-failure-testing-scenarios-from-obama-for-america.html)中测试了这些。

感谢 [Pris Nasrat](https://twitter.com/nasrat) 的认真阅读、笔记和参考资料，感谢 [CJ Rayhill](https://www.plos.org/people#loc-cj-rayhill) 的指导和智慧。